---
layout: post
title: crm03
tags:
- java

categories: java
description: crm
---
## 课程类别
###### jsp
```javascript
<s:form namespace="/" action="courseTypeAction_findAll">
	<table width="88%" border="0" class="emp_table" style="width:80%;">
	  <tr>
	    <td width="10%">课程类别：</td>
	    <td><s:textfield name="courseName" size="30"></s:textfield></td>
	  </tr>
	  <tr>
	    <td >课程简介：</td>
	    <td ><s:textfield name="remark" size="30" ></s:textfield></td>
	  </tr>
	  <tr>  
	    <td >总学时：</td>
	    <td >
	    	<s:textfield name="totalStart" size="12"></s:textfield>  
	    	至  
	    	<s:textfield name="totalEnd" size="12"></s:textfield>
	    </td>
```

###### 修改PO类 CrmCourseType
```java
	//查询条件 -- 一般查询条件都是字符串
	//1 总学时
	private String totalStart;
	private String totalEnd;
	//2课程费用
	private String courseCostStart;
	private String courseCostEnd;
````


###### action获得条件
```java
	/**
	 * 查询所有
	 * @return
	 */
	public String findAll(){
		/*1简单查询
		List<CrmCourseType> allCourseType = this.courseTypeService.findAll();
		// * 查询结果存在值栈 , jsp 通过“#key”获得
		ActionContext.getContext().put("allCourseType", allCourseType);
		*/

		/*2 条件查询
		 */
		List<CrmCourseType> allCourseType = this.courseTypeService.findAll(courseType);
		ActionContext.getContext().put("allCourseType", allCourseType);

		return "findAll";
	}
```
###### service拼凑条件
>使用StringBuilder 拼凑字符串，所有的条件格式“ and 属性 运算符 ? ”
	toString 转成字符串
> 使用List拼凑实际参数，使用List特性：重复、有序
	toArray 转成数组
> commons-lang3 提供 StringUtils工具类  

```java
@Override
	public List<CrmCourseType> findAll(CrmCourseType courseType) {
		//1.1 拼凑查询条件
		StringBuilder builder = new StringBuilder();
		//1.2 拼凑实际参数 , 可以重复，顺序 --> List
		List<Object> paramsList = new ArrayList<Object>();

		//2 过滤条件
		// 2.1 课程类别
		if(StringUtils.isNotBlank(courseType.getCourseName())){
			builder.append(" and courseName like ?");
			paramsList.add("%"+courseType.getCourseName()+"%");
		}
		// 2.2 课程简介
		if(StringUtils.isNotBlank(courseType.getRemark())){
			builder.append(" and remark like ?");
			paramsList.add("%"+courseType.getRemark()+"%");
		}
		// 2.3 总学时：
		if(StringUtils.isNotBlank(courseType.getTotalStart())){
			builder.append(" and total >= ?");
			paramsList.add(Integer.parseInt(courseType.getTotalStart()));
		}
		if(StringUtils.isNotBlank(courseType.getTotalEnd())){
			builder.append(" and total <= ?");
			paramsList.add(Integer.parseInt(courseType.getTotalEnd()));
		}
		// 2.4课程费用
		if(StringUtils.isNotBlank(courseType.getCourseCostStart())){
			builder.append(" and courseCost >= ?");
			paramsList.add(Double.parseDouble(courseType.getCourseCostStart()));
		}
		if(StringUtils.isNotBlank(courseType.getCourseCostEnd())){
			builder.append(" and courseCost <= ?");
			paramsList.add(Double.parseDouble(courseType.getCourseCostEnd()));
		}



		//3 使用
		// 条件 , 格式：" and ..? and ..."
		String condition = builder.toString();
		// 实际参数
		Object[] params = paramsList.toArray();

		return courseTypeDao.findAll(condition, params);
	}
```



###### dao查询
> service拼凑查询条件，dao直接使用，通过where 1=1 产生一个恒定条件
```
	@Override
	public List<CrmCourseType> findAll(String condition, Object[] params) {
		String hql = "from CrmCourseType where 1=1 " + condition;
		return this.getHibernateTemplate().find(hql , params);
	}

```
###### 分页查询







## 课程类别添加或编辑
> 1.dao ，hibernate 提供 saveOrUpdate()
	代理主键 uuid
		如果没有OID，值为null，底层执行save() ，及insert语句
		如果有OID，有值，底层执行update()，及update语句。
	查询详情
> 2.service  需要事务管理器 （add、update、delete、find）
	addOrEdit
>3.action 类
	addOrEditUI 显示jsp
		如果是更新，需要通过id查询详情  findById()
	addOrEdit
		直接保存或更新，注意：如果更新需要传递id值
> 4.jsp
	添加，直接显示jsp页面
	编辑，传递id值，通过id查询，显示jsp页面


###### dao
> 编辑需要查询
> 添加和编辑直接执行saveOrUpdate
```java
	@Override
	public CrmCourseType findById(String courseTypeId) {
		return this.getHibernateTemplate().get(CrmCourseType.class, courseTypeId);
	}

	@Override
	public void saveOrUpdate(CrmCourseType courseType) {
		this.getHibernateTemplate().saveOrUpdate(courseType);
	}

```
###### service
```java
	@Override
	public CrmCourseType findById(String courseTypeId) {
		return this.courseTypeDao.findById(courseTypeId);
	}
	@Override
	public void addOrEdit(CrmCourseType courseType) {
		this.courseTypeDao.saveOrUpdate(courseType);
	}
```
######	action
>	添加需要显示jsp，不进行查询
>	更新需要显示jsp，进行查询，使用id进行区分。

```java
/**
	 * 添加或编辑显示jsp页面
	 * @return
	 */
	public String addOrEditUI(){
		//如果有id就是编辑，编辑需要查询详情
		if(StringUtils.isNotBlank(this.courseType.getCourseTypeId())){
			//将查询的详情压入到栈顶，方便标签自动的回显
			CrmCourseType findCourseType = this.courseTypeService.findById(this.courseType.getCourseTypeId());
			ActionContext.getContext().getValueStack().push(findCourseType);
		}

		return "addOrEditUI";
	}

	/**
	 * 添加或编辑 功能
	 * @return
	 */
	public String addOrEdit(){
		this.courseTypeService.addOrEdit(courseType);
		return "addOrEdit";
	}
```
##### jsp页面
> 使用标签进行回显
> 提供隐藏字段进行更新，添加不需要

```javascript
<s:form namespace="/" action="courseTypeAction_addOrEdit">
	<%--隐藏域 ,如果有值，及更新时才显示--%>
	<s:if test="courseTypeId != null">
		<s:hidden name="courseTypeId" value="%{courseTypeId}"></s:hidden>
	</s:if>
	<table width="88%" border="0" class="emp_table" style="width:80%;">
	  <tr>
	    <td width="10%">课程类别：</td>
	    <td width="20%"><s:textfield name="courseName"></s:textfield></td>
	    <td width="8%">总学时：</td>
	    <td width="62%"><s:textfield name="total"></s:textfield></td>
	  </tr>
	  <tr>
	    <td>课程费用：</td>
	    <td><s:textfield name="courseCost"></s:textfield></td>
	    <td></td>
	    <td></td>
	  </tr>
	  <tr>
	    <td>课程简介：</td>
	    <td>&nbsp;</td>
	    <td>&nbsp;</td>
	    <td>&nbsp;</td>
	  </tr>
	  <tr>
	    <td colspan="4">
	    	<s:textarea name="remark" cols="60" rows="10" ></s:textarea>
	    </td>
	  </tr>
	</table>
</s:form>

```






## BaseAction
> 1.封装数据
> 2.所有的service
> 3.分页
> 4.值栈简化操作

####	封装数据
```java
public class BaseAction<T> extends ActionSupport implements ModelDriven<T> {

	//1 封装数据
	private T t;
	@Override
	public T getModel() {
		return t;
	}
	// 1.1 实例化t
	public BaseAction() {
		try {
			//1 获得T运行时Class
			ParameterizedType paramType = (ParameterizedType) this.getClass().getGenericSuperclass();
			Class<T> clazz = (Class<T>) paramType.getActualTypeArguments()[0];
			//2 反射创建实例
			t = clazz.newInstance();
		} catch (Exception e) {
			throw new RuntimeException(e);
		}
	}

```
######	service注入
```java
//2 spring注入service，多个
	// * 提供setter方法，让spring进行注入的
	// * 提供getter方法，让子类可以获得spring注入的对象的。
	//员工
	private StaffService staffService;
	public void setStaffService(StaffService staffService) {
		this.staffService = staffService;
	}
	public StaffService getStaffService() {
		return staffService;
	}


	//职务
	private PostService postService;
	public PostService getPostService() {
		return postService;
	}
	public void setPostService(PostService postService) {
		this.postService = postService;
	}
	//部门
	private DepartmentService departmentService;
	public DepartmentService getDepartmentService() {
		return departmentService;
	}
	public void setDepartmentService(DepartmentService departmentService) {
		this.departmentService = departmentService;
	}

	//课程类别
	private CourseTypeService courseTypeService;
	public void setCourseTypeService(CourseTypeService courseTypeService) {
		this.courseTypeService = courseTypeService;
	}
	public CourseTypeService getCourseTypeService() {
		return courseTypeService;
	}
	//班级
```
######	分页
```java
//3 分页数据
	private int pageNum = 1;
	public void setPageNum(int pageNum) {
		this.pageNum = pageNum;
	}
	public int getPageNum() {
		return pageNum;
	}
	private int pageSize = 2;  //固定值
	public void setPageSize(int pageSize) {
		this.pageSize = pageSize;
	}
	public int getPageSize() {
		return pageSize;
	}
```
###### 简化值栈操作
```java
//4 简化值栈操作
	public void push(Object o){
		ActionContext.getContext().getValueStack().push(o);
	}

	public void set(String key ,Object o){
		ActionContext.getContext().getValueStack().set(key, o);
	}

	public void put(String key, Object value){
		ActionContext.getContext().put(key, value);
	}

	public void putSession(String key, Object value){
		ActionContext.getContext().getSession().put(key, value);
	}

	public void putApplication(String key, Object value){
		ActionContext.getContext().getApplication().put(key, value);
	}

```

## 上传/下载

###### 班级查询
```html
1.dao  --> BaseDao  / BaseDaoImpl
2.service
3.spring配置 , 完成BaseAction
4.action  --> BaseAction
5. jsp  xml  action
```




###### 文件上传
```java
0.通过id查询详情
1.表单 <form method="post"  enctype="multipart/form-data">
			<input type="file" name="schedule">
2.action类
	private File schedule;	// 内容
	private String scheduleFileName;	// 文件名
	private String scheduleContentType;	// 类型
	提供setter方法即可
3.将课表保存到硬盘，将路径、文件名、更新时间  更新到数据库

4.拦截器设置
<!-- 给拦截器栈中的某一个拦截器注入内容时，
					格式：拦截器.属性 = 值
				-->
				<interceptor-ref name="defaultStack">
					<param name="fileUpload.allowedExtensions">.xls,.xlsx</param>
				</interceptor-ref>

```
######	下载
```html
struts.xml result 提供stream类型
	inputName  设置InputStream 获得 属性值，需要提供getter方法
	contentDisposition 设置  attachment;filename=${imageFileName} 获得文件名称
```
