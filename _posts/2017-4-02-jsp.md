---
layout: post
title: jsp
tags:
- java

categories: java
description: jsp
---
## JSP 概述
> Java Server Pages，它和servlet技术一样,都是sun公司定义用于开发动态资源的技术,jsp实际上就是Servlet
> jsp=html+java
> html静态内容，servlet服务端小应用程序适合编写java逻辑代码 ，jsp:适合编写输出动态内容，单不适合编写java逻辑
## JSP运行原理
> 服务器会将.jsp转译成.java文件，再将.java编译成.class,html内容直接输出
> mac idea .jsp编译目录:
/Users/zhangxiaolong/Library/Caches/IntelliJIdea2017.1/tomcat/Unnamed_Learn38/work/Catalina/localhost/ROOT/org/apache/jsp
###### 转译后
```java
public void _jspService(final javax.servlet.http.HttpServletRequest request, final javax.servlet.http.HttpServletResponse response)
      throws java.io.IOException, javax.servlet.ServletException {

    final java.lang.String _jspx_method = request.getMethod();
    if (!"GET".equals(_jspx_method) && !"POST".equals(_jspx_method) && !"HEAD".equals(_jspx_method) && !javax.servlet.DispatcherType.ERROR.equals(request.getDispatcherType())) {
      response.sendError(HttpServletResponse.SC_METHOD_NOT_ALLOWED, "JSPs only permit GET POST or HEAD");
      return;
    }

    final javax.servlet.jsp.PageContext pageContext;
    javax.servlet.http.HttpSession session = null;
    final javax.servlet.ServletContext application;
    final javax.servlet.ServletConfig config;
    javax.servlet.jsp.JspWriter out = null;
    final java.lang.Object page = this;
    javax.servlet.jsp.JspWriter _jspx_out = null;
    javax.servlet.jsp.PageContext _jspx_page_context = null;


    try {
      response.setContentType("text/html;charset=UTF-8");
      pageContext = _jspxFactory.getPageContext(this, request, response,
      			null, true, 8192, true);
      _jspx_page_context = pageContext;
      application = pageContext.getServletContext();
      config = pageContext.getServletConfig();
      session = pageContext.getSession();
      out = pageContext.getOut();
      _jspx_out = out;

      out.write("\n");
      out.write("\n");
      out.write("<html>\n");
      out.write("  <head>\n");
      out.write("    <title>My Jsp2</title>\n");
      out.write("  </head>\n");
      out.write("  <body>\n");
      out.write("  <form>\n");
      out.write("      <input type=\"text\" name=\"username\">\n");
      out.write("  </form>\n");
      out.write("      ");

        Date date=new Date();
        out.println(date.toLocaleString());

      out.write("\n");
      out.write("  </body>\n");
      out.write("</html>\n");
    } catch (java.lang.Throwable t) {
      if (!(t instanceof javax.servlet.jsp.SkipPageException)){
        out = _jspx_out;
        if (out != null && out.getBufferSize() != 0)
          try {
            if (response.isCommitted()) {
              out.flush();
            } else {
              out.clearBuffer();
            }
          } catch (java.io.IOException e) {}
        if (_jspx_page_context != null) _jspx_page_context.handlePageException(t);
        else throw new ServletException(t);
      }
    } finally {
      _jspxFactory.releasePageContext(_jspx_page_context);
    }
  }
```
## jsp的最佳实践
>serlvet:控制器,重点编写java代码逻辑
>jsp:代码显示模板，重点在于显示数据

```javascript
//login.jsp
<body>
    <form action="/doLogin" method="post">
        用户名:<input type="text" name="userName"><br/>
        密码:<input type="password" name="pwd"><br/>
        <input type="submit" value="登陆">

    </form>
</body>


//DoLoginServlet
protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
    req.setCharacterEncoding("utf-8");
    String userName = req.getParameter("userName");
    String pwd = req.getParameter("pwd");
    if("tom".equals(userName)&&"123".equals(pwd)){
        req.getRequestDispatcher("/success.jsp").forward(req,resp);
        req.getSession().setAttribute("name",userName);
    }else {
        req.getRequestDispatcher("/login.jsp").forward(req,resp);
    }
}


//success.jsp
<body>
    欢迎您:<%
        String userName=request.getParameter("userName");
        out.println(userName);
    %>
    <br/>
    <a href="home.jsp">跳到主页</a>
</body>


//home.jsp
<body>
    <h1>欢迎来到本网站</h1>
    欢迎您:
    <%
        String userName = (String) session.getAttribute("name");
        out.println(userName);
    %>
</body>
```
## jsp的基本语法
|语法|备注|
|-----|-----|
|网页的静态内容|如html标签和文本|
|jsp脚本||
|小脚本|<%java代码%>|
|表达式|<%=%><%=i%>等价于int i=30,out.println(i),不能有;|
|声明| <%!%>全局变量 每次刷新值都不会变|
|注释|<!--这是html注释 不安全费流量--><%--这是jsp注释 安全不费流量--%> //java单行注释 /*java多行注释*/|
|jsp指令|不产生可见输出，告示引擎如果处理jsp其余部分|
|语法|<%@ 指令名称 属性1=“属性值” 属性n="属性值"%>|
|page指令|定义jsp页面各个属性|
|language|<%@ page language="java"%>jsp支持的语言|
|extends|<%@ page extend="package.class"%> 继承|
|import|和java import一样 <%@ page import="java.util.Date"% > <%@ page import="java.util.Date,java.sql.*"%>|
|import自动导入的包|import java.long.*   import javax.servlet.*;   import javax.servlet.http.*  import javax.servlet.jsp.*|
|session|<%@ page session="false"%>默认true,false不会创建session|
|buffer|<%@ page buffer="none \| 8kb \| sizekb"%>out.println()缓冲区大小 默认8kb 不建议改动|
|autoFlush|<%@ page autoFlush="true \| false"%>自动清空缓冲区  默认true 不建议改动|
|isThreadSafe|<%@ page isThreadSafe="true \| false"%>默认true false才继承SingleThreadModle接口(来一个请求创建一个servlet)|
|info|<%@ page info="text"%>输出页面基本信息 Servlet.getServletInfo方法取回|
|errorPage|出错后跳转的页面<%@ page errorPage="ralative_url"%> /是绝对路径 不写/是相对路径|
|isErrorPage|<%@ page isErrorPage="true \| false"%> 是否创建throwable对象，默认是false,创建可以打印错误信息 <%exception.getMessage()%>|
|contentType|等同于reponse.setContentType()<%@ page contentType="text/html;charset=utf-8"%>|
|pageEncoding|<%@ page pageEncoding="utf-8"% 告示服务用什么编码编译 同时包装contentType>
|include指令||
|静态包含|<%@include file="/include/header.jsp" %> 在编译时就把两个文件合并|
|动态包含|&lt;jsp:include page="/include/header.jsp"> 不会合并文件，当代码执行到include才会包含文件内容|
|taglib指令|在jsp页面中导入JSTL标签库，替换jsp中的java代码段 <%@taglib uri="http://java.sun.com/jsp/jsp/jst1/core" prefix="c"%>|
|6个动作|
|动态包含|&lt;jsp:include>&lt;jsp:include page="2.jsp">&lt;/jsp:include>|
|请求转发|&lt;jsp:forward page="5.jsp">&lt;jsp:param name="name" value="1234&gt;|
|设置请求参数|&lt;jsp:param name="name" value="1234"></jsp:param>|
|创建对象|&lt;jsp:useBean id="stu2" class="com.itheima.entity.Student">|
|属性赋值|&lt;jsp:setProperty name="stu2" property="name" value="jerry">|
|取属性值|&lt;jsp:getProperty name="stu2" property="name">|
|9大内置对象|在<%%>和<%=%>中直接使用的对象|
|request|javax.serlvet.http.HttpServletRequest,域对象|
|response|javax.servlet.http.HttpServletResponse|
|session|javax.servlet.http.HttpSession 由session="true"开关,域对象|
|application|javax.servlet.http.ServletContext|
|exception|java.lang.Throwable 由isErrorPage="false"开关,域对象|
|page|java.lang.Object 当前对象this，当前servlet|
|config|javax.servlet.ServletConfig|
|out|javax.servlet.jsp.JspWriter相当于printWriter|
|pageContext|javax.servlet.jsp.PageContext,相当于当前页面的上下文,域对象|
```javascript
//1.jsp
<%@ page contentType="text/html;charset=UTF-8" language="java"  %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<html>
<head>
    <title>Title</title>
</head>
<body>
    bbbbbbbbbbbb
    <%@ include file="2.jsp"%>
    <jsp:include page="3.jsp"></jsp:include>
    <%
        if(5>3){
            out.println("aaaaa");
        }
        %>
    <c:if test="${5>3}">
        aaaaa
    </c:if>

//2.jsp
aaaaaaaaa

//3.jsp
cccccccccccc
</body>
</html>
```

## PageContext
> 本身是一个域对象，它可以操作其他三个域对象
> 它可以创建其他8个隐式对象
> 提供简易api pageContext.forward("2.jsp") pageContext.include("2.jsp")

|方法|备注|
|----|----|
|setAttribute(name,value)||
|getAttribute(name)||
|removeAttribute(name)||
|setAttribute(name,obj,scope)|
|getAttribute(name,scope)
|removeAttribute(name,scope)|
|findAttribute(name)|自动从page,request,session,application依次查找|
|PageContext.PAGE_SCOPE| scope的值，操作page的域对象|
|PageContext.REQUEST_SCOPE| scope的值，操作request的域对象|
|PageContext.SESSION_SCOPE| scope的值，操作session的域对象|
|PageContext.APPLICATION_SCOPE| scope的值，操作PageContext的域对象|
```javascript
//6.jsp
<body>
    <%
        pageContext.setAttribute("scope","page");
        pageContext.setAttribute("scope","request",PageContext.REQUEST_SCOPE);
        pageContext.setAttribute("scope","session",PageContext.SESSION_SCOPE);
        pageContext.setAttribute("scope","application",PageContext.APPLICATION_SCOPE);
        request.getRequestDispatcher("7.jsp").forward(request,response);
    %>
</body>

//7.jsp
<body>
    <%
        String scope1 = (String) pageContext.getAttribute("scope");
        out.println(scope1);//null pageContext作用域本页面
        String scope2= (String) pageContext.getAttribute("scope",PageContext.REQUEST_SCOPE);
        out.println(scope2);//转发可以取到 重定向取不到
        String scope3= (String) pageContext.getAttribute("scope",PageContext.SESSION_SCOPE);
        out.println(scope3);//转发重定向都可以取到
        String scope4= (String) pageContext.getAttribute("scope",PageContext.APPLICATION_SCOPE);
        out.println(scope4);//转发重定向都可以取到
        String scope = (String) pageContext.findAttribute("scope");
        out.println(scope);

    %>
</body>
```
## 四大域对象

+ PageContext:存放的数据在当前页面有效，开发时使用较少
+ ServletRequest:request,存放的数据在一次请求(转发)内有效，使用非常多
+ HttpSession: session,存放的数据在一次会话内有效，使用比较多，存放登陆信息，购物车功能
+ ServlertContext:application,存放的数据在整个应用范围内有效，范围太大，应尽量少用

## EL表达式
> expression language 表达式语言
> 简化jsp中java代码

+ 获取数据
1. EL 表达式只能获取存在4个作用域中的数据
1. \${u}原理:pageContext.findAttribute("u");
1. EL获取对于null这样的数据，在页面中表现为空字符串，\${u.name} u为空也不会报错
1. \${u.name}==u.getName() .运算符想大于调用了getter方法
1. 属性导航 \${u.address.city}
1. []运算符: \${u.name}==\${u['name']}==\${u["name"]}
```javascript
//demo8.jsp
<body>
    <%
        Student stu=new Student();
        stu.setName("tom");
        request.setAttribute("stu",stu);
        request.getRequestDispatcher("demo9.jsp").forward(request,response);
    %>
</body>

//demo9.jsp
<body>
    <%
        Student stu= (Student) request.getAttribute("stu");
        out.println(stu);
        out.println(stu.getName());
    %><br/>
    ${stu}<!--${stu}==pageContext.findAttribute("stu")--><br/>
    ${stu.name}<br/>
    ${stu.city.address}<br/>
    ${stu['city']["address"]}<br/>
    <%
        List list=new ArrayList();
        list.add("aaa");
        list.add("bbb");
        pageContext.setAttribute("list",list);
    %>
    ${list}<br/>
    ${list[1]}<br/>
    <%
        Map map=new HashMap();
        map.put("key0","value0");
        map.put("key1","value1");
        pageContext.setAttribute("map",map);
    %>
    ${map.key1}<br/>
    ${map["key1"]}<br/>
</body>
```
+ 运算
    1. empty \$[ empty str} 判断null,空字符串和没有元素的集合都返回true
    2. 三元运算符 \${ empty list? "您还没有购买商品":"你买的商品有"}
```javascript
<body>
     <%
        String s1=null;pageContext.setAttribute("s1",s1);
        String s2="";pageContext.setAttribute("s2",s2);
        String s3="abc";pageContext.setAttribute("s3",s3);
        List list1=null;pageContext.setAttribute("list1",list1);
        List list2=new ArrayList();pageContext.setAttribute("list2",list2);
        List list3=new ArrayList();
        list3.add("aaa");pageContext.setAttribute("list3",list3);
        int sex=1;pageContext.setAttribute("sex",sex);
     %>
     ${ empty s1} <br/> <%--true--%>
     ${ empty s2} <br/> <%--true--%>
     ${ empty s3} <br/> <%--false--%>
     ${ empty list1} <br/> <%--true--%>
     ${ empty list2} <br/> <%--true--%>
     ${ empty list3} <br/> <%--false--%>
     ${ empty list1? "你还没有购买商品" : "你买的商品如下"}<br/>
     <input type="radio" value="男" name="sex" ${sex==0?"checked='checked'":""}>男<br/>
     <input type="radio" value="女" name="sex" ${sex==1?"checked='checked'":""}>女<br/>
</body>
```
+ 隐式对象 11个

|EL引用名称| 说明 |类型|
|-------------|-----|------|
|pageContext|和jsp pageContext一样的,域对象|javax.servlet.jsp.PageContext|
|pageScope|pageContext范围中存放的数据，页面范围,域对象|java.util.Map<Stirng,Object|
|requestScope|请求范围数据,域对象|java.util.Map<String,Object||
|sessionScope|会话范围数据,域对象|java.util.Map<String,Object|
|applicationScope|应用范围数据,域对象|java.util.Map<String,Object|
|param|一个请求参数|java.util.Map<String,String>|
|paramValues|重名请求参数|java.util.Map<String,String[]|
|header|一个请求消息头|java.util.Map<Stirng,String>|
|headerValues|重名消息头|java.util.Map<String,String[]>|
|initParam|web.xml中全局参数|java.util.Map<String,String>|
|cookie|key: cookie对象的name,域对象java.util.Map<String,Cookie>|

```javascript
<body>
    <%
        pageContext.setAttribute("scope","page");
        pageContext.setAttribute("scope","request",PageContext.REQUEST_SCOPE);
        pageContext.setAttribute("scope","session",PageContext.SESSION_SCOPE);
        pageContext.setAttribute("scope","application",PageContext.APPLICATION_SCOPE);
    %>
    ${scope}<br/>
    ${pageScope.get("scope")}<br/>
    ${requestScope.scope}<br/>
    ${sessionScope.scope}<br/>
    ${applicationScope.scope}<br/>
    ${param.userName}<br/><%--/demo11.jsp?userName=tom--%>
    ${paramValues.hobby[1]}<br/><%--/demo11.jsp?hobby=篮球&hobby=足球--%>
    ${header["User-agent"]}<br/>
    ${cookie.JSESSIONID.value}<br/>
    <%=request.getScheme()+"//"+request.getServerName()+":"+request.getServerPort()+request.getContextPath()%><br/>
    ${pageContext.request.scheme}
</body>
```
## JSTL
> JSTL(JavaServerPage Standard Tag Library) jsp标准标签库
> 作用:实现jsp页面中逻辑处理，如判断，循环
> 使用:1)在jspt添加taglib指令<% taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
> 使用标签<c:if test=""></c:if>
+ 通用标签 set、out、remove
+ 条件标签 if choose
+ 迭代标签 foreach

```html
<body>
    <c:set var="num" value="10" scope="page"></c:set><%--声明一个变量 变量名num值10--%>
    输出变量:<c:out value="${num}"></c:out><br/>
    <c:remove var="num"></c:remove>
    输出变量:<c:out value="${num}" default="默认值5"></c:out><br/>
    <c:if test="${5>3}">
        5>3
    </c:if><br/>
    <c:set var="num" value="${3}"></c:set>
    <c:choose>
        <c:when test="${num==1}">1111</c:when>
        <c:when test="${num==2}">1111</c:when>
        <c:when test="${num==3}">3333</c:when>
    </c:choose><br/>
    <c:forEach var="i" begin="1" end="10" step="1"><%--step i+=--%>
        ${i}
    </c:forEach><br/>
    <%
        List list=new ArrayList();
        list.add("aaa");
        list.add("bbb");
        list.add("ccc");
        list.add("ddd");
        list.add("eee");
        list.add("fff");
        pageContext.setAttribute("list",list);
    %>
    <c:forEach items="${list}" var="item">
        ${item}
    </c:forEach>
    <table border="1">
        <tr>
            <th>数据</th>
            <th>索引</th>
            <th>计数</th>
            <th>第一个</th>
            <th>最后一个</th>
        </tr>
        <c:forEach items="${list}" var="item" varStatus="vs">
            <tr ${vs.index%2==0?"style='background-color:lime'":"style='background-color:green'"}>
                <td>${item}</td>
                <td>${vs.index}</td><%--索引--%>
                <td>${vs.count}</td><%--计数--%>
                <td>${vs.first}</td><%--第一个--%>
                <td>${vs.last}</td><%--最后一个--%>
            </tr>
        </c:forEach>
    </table>
</body>
```
