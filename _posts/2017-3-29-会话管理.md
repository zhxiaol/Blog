---
layout: post
title: Oracle02
tags:
- java

categories: java
description: Oracle02
---
## 什么是会话
> 用户打开一个浏览器，访问服务器多个web资源，然后关闭浏览器，整个过程称之为会话
## Cookie
> Cookie是客服端技术，把用户数据存储在各自浏览器，再去访问带着数据访问。这样web资源就能处理各自数据
|方法|备注|
|-----|-----|
|response.addCookie()|可以多次调用|
|request.getCookies()||
|new Cookie(name,value)|一个cookie里面有一个名字,一个值，多个cookie名字可以相同|
|cookie.getName()|获得cookie名称|
|cookie.getValue()|获得cookie值|
|cookie.getMaxAge()|得到cookie保留时间单位秒，-1表示保留到浏览器关闭|
|cookie.setMaxAge(expiry)|设置cookie缓存到硬盘上的时间单位秒，浏览器关闭之后保留的时间|
|cookie.setMaxAge(0)|删除cookie|
|cookie.getPath()|默认值是写Cookie程序的访问路径，URI。名字和path都相同为同一个cookie|
###### ServletDemo1
```
public class CookieDemo1 extends HttpServlet {
    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        doGet(req,resp);
    }

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        resp.setContentType("text/html;charset=utf-8");
        PrintWriter out = resp.getWriter();
        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
        Cookie[] cookies = req.getCookies();
        for(int i=0;cookies!=null&&i<cookies.length;i++){
            if("lastAccessTime".equals(cookies[i].getName())){
                long time=Long.parseLong(cookies[i].getValue());
                String s = sdf.format(new Date(time));
                out.println("您最后访问时间:"+s);
            }
        }
        Cookie c=new Cookie("lastAccessTime",new Date().getTime()+"");
        c.setMaxAge(60*5);//浏览器关闭保留5分钟
        c.setPath(req.getContextPath());
        resp.addCookie(c);
        out.println("<a href='"+req.getContextPath()+"/clean'>clean</a>");
    }
}
```
###### ServletDemo2
```
public class CookieDemo2 extends HttpServlet {
    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        doGet(req,resp);
    }

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        resp.setContentType("text/html;charset=utf-8");
        PrintWriter out = resp.getWriter();
        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
        Cookie[] cookies = req.getCookies();
        for(int i=0;cookies!=null&&i<cookies.length;i++){
            if("lastAccessTime".equals(cookies[i].getName())){
                long time=Long.parseLong(cookies[i].getValue());
                String s = sdf.format(new Date(time));
                out.println("您最后访问时间:"+s);
            }
        }

    }
}
```
###### CleanServlet
```
public class CleanSevlet extends HttpServlet {
    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        doGet(req,resp);
    }

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        Cookie cookie = new Cookie("lastAccessTime", "");
        cookie.setMaxAge(0);
        cookie.setPath(req.getContextPath());
        resp.addCookie(cookie);
    }
}
```

###### LoginServlet
```
protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
    resp.setContentType("text/html;charset=utf-8");
    PrintWriter out = resp.getWriter();
    Cookie[] cookies = req.getCookies();
    String username="";
    String checked="";
    for(int i=0;cookies!=null&&i<cookies.length;i++){
        if("username".equals(cookies[i].getName())){
            username=cookies[i].getValue();
            checked="checked='checked'";
        }
    }
    out.write("<form action='"+req.getContextPath()+"/dologin' method=post>");
    out.write("用户名:<input type='text' name='username' value='"+username+"'/><br/>");
    out.write("密码:<input type='password' name='pwd'/><br/>");
    out.write("记住密码:<input type='checkbox' name='remember'"+checked+"/><br/>");
    out.write("<input type='submit' value='登陆'/><br/>");
    out.write("</form>");
}
```
###### doLoginServlet
```
protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
    req.setCharacterEncoding("utf-8");
    resp.setContentType("text/html;charset=utf-8");
    PrintWriter out = resp.getWriter();
    String username = req.getParameter("username");
    String pwd = req.getParameter("pwd");
    String remember = req.getParameter("remember");
    Cookie cookie=new Cookie("username",username);
    cookie.setPath(req.getContextPath());
    if("tom".equals(username)&&"123".equals(pwd)){
        out.println("登陆成功");
    }else {
        out.println("登陆失败");
        resp.setHeader("refresh","2;url="+req.getContextPath()+"/login");
    }
    if(remember!=null){
        cookie.setMaxAge(Integer.MAX_VALUE);
    }else {
        cookie.setMaxAge(0);
    }
    resp.addCookie(cookie);
}
```
##### 浏览记录
###### dbtuil
```
public class DBUtil {
    private static final String url;
    private static final String user;
    private static final String password;
    static {
        ResourceBundle rb=ResourceBundle.getBundle("dbutil");
        url=rb.getString("url");
        user=rb.getString("user");
        password=rb.getString("password");
        String classDriver=rb.getString("classDriver");
        try {
            Class.forName(classDriver);
        } catch (ClassNotFoundException e) {
            e.printStackTrace();
        }
    }
    public static Connection getConnection() throws SQLException {
        return DriverManager.getConnection(url,user,password);
    }
}
```
###### BookService
```
public class BookService {
    public static HashMap<String,Book> findBookByIds(List<String> ids){
        System.out.println("查询IDS:"+ids);
        HashMap<String, Book> books = new HashMap<>();
        if(ids==null||ids.size()==0)
            return books;
        StringBuilder sb = new StringBuilder();
        sb.append("select * from book where id in (");
        for(String id:ids){
            sb.append(id);
            sb.append(",");
        }
        sb.deleteCharAt(sb.length()-1);
        sb.append(")");
        System.out.println("SQL语句:"+sb.toString());
        try(Connection conn= DBUtil.getConnection();
            PreparedStatement ps=conn.prepareStatement(sb.toString());
            ResultSet rs=ps.executeQuery();
        ){
            while(rs.next()){
                Book book = new Book();
                book.id=rs.getString("id");
                book.name=rs.getString("name");
                book.price=rs.getString("price");
                book.author=rs.getString("author");
                books.put(book.id,book);
            }
        }catch (Exception e){
            e.printStackTrace();
        }
        return books;
    }
    public static ArrayList<Book> findBookByIdsOrder(List<String> ids){
        ArrayList<Book> books = new ArrayList<>();
        if(ids==null||ids.size()==0)
            return books;
        HashMap<String, Book> map = findBookByIds(ids);
        for(String id:ids){
            books.add(map.get(id));
        }
        return books;
    }
    public static ArrayList<Book> findBookByIdsOrder(String... ids){
        if(ids==null||ids.length==0) {
            ArrayList<Book> books = new ArrayList<>();
            return books;
        }
        return findBookByIdsOrder(Arrays.asList(ids));
    }
    public static ArrayList<Book> findAllBooks(){
        ArrayList<Book> books = new ArrayList<>();
        try(Connection conn= DBUtil.getConnection();
            PreparedStatement ps=conn.prepareStatement("select * from book");
            ResultSet rs=ps.executeQuery();
        ){
            while(rs.next()){
                Book book = new Book();
                book.id=rs.getString("id");
                book.name=rs.getString("name");
                book.price=rs.getString("price");
                book.author=rs.getString("author");
                books.add(book);
            }
        }catch (Exception e){
            e.printStackTrace();
        }
        return books;
    }
    public static Book findBookById(String id){
        try(Connection conn= DBUtil.getConnection();
            PreparedStatement ps=conn.prepareStatement("select * from book where id ="+id);
            ResultSet rs=ps.executeQuery();
        ){
            while(rs.next()){
                Book book = new Book();
                book.id=rs.getString("id");
                book.name=rs.getString("name");
                book.price=rs.getString("price");
                book.author=rs.getString("author");
                return book;
            }
        }catch (Exception e){
            e.printStackTrace();
        }
        return null;
    }
}
```
###### ShowAllBooksServlet
```
public class ShowAllBooksServlet extends HttpServlet {
    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        doGet(req,resp);
    }

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        resp.setContentType("text/html;charset=utf-8");
        PrintWriter out = resp.getWriter();
        out.write("本网站有以下好书:<br/>");
        ArrayList<Book> books = BookService.findAllBooks();
        for(Book book:books){
            out.write("<a href='"+req.getContextPath()+"/showBookDetail?id="+
                    book.id+"'>"+book.name+"</a><br/>");
        }
        out.write("<hr/>您最近浏览过的书有:<br/>");
        Cookie[] cookies = req.getCookies();
        for(int i=0;cookies!=null&&i<cookies.length;i++){
            if("historyBookId".equals(cookies[i].getName())){
                String ids=cookies[i].getValue();
                String[] arr = ids.split("-");
                ArrayList<Book> historyBooks = BookService.findBookByIdsOrder(arr);
                for(Book book:historyBooks){
                    out.write("<a href='"+req.getContextPath()+"/showBookDetail?id="+
                            book.id+"'>"+book.name+"</a><br/>");
                }
            }
        }
    }
}
```
###### ShowBookDetail
```
public class ShowBookDetail extends HttpServlet {
    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        doGet(req,resp);
    }
    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        req.setCharacterEncoding("utf-8");
        resp.setContentType("text/html;charset=utf-8");
        String id = req.getParameter("id");
        Book book = BookService.findBookById(id);
        PrintWriter out = resp.getWriter();
        out.println(book);
        String historyId=id;
        Cookie[] cookies = req.getCookies();
        for(int i=0;cookies!=null&&i<cookies.length;i++){
            if("historyBookId".equals(cookies[i].getName())){
                String ids=cookies[i].getValue();
                String[] arr = ids.split("-");
                if(arr!=null) {
                    LinkedList<String> list=new LinkedList();
                    list.addAll(Arrays.asList(arr));
                    if(list.contains(historyId))
                        list.remove(historyId);
                    if(list.size()==10)//最多保存10本书
                        list.removeLast();
                    list.addFirst(historyId);
                    StringBuilder sb = new StringBuilder();
                    for(String s:list){
                        sb.append(s);
                        sb.append("-");
                    }
                    sb.deleteCharAt(sb.length()-1);
                    historyId=sb.toString();
                }
            }
        }
        System.out.println("浏览记录id:"+historyId);
        Cookie cookie = new Cookie("historyBookId", historyId);
        cookie.setPath(req.getContextPath());
        cookie.setMaxAge(Integer.MAX_VALUE);
        resp.addCookie(cookie);
    }
}
```


## HttpSession
> session是服务器技术，服务器为每一个用户创建一个独享的HttpSession,可以把各自数据放在各自session中，其他web资源可取出数据服务用户
|方法|备注|
|-----|-----|
|request.getSession()|获得session,为每个浏览器创建一个session|
|session.setAttribute(name,object)|存储数据|
|session.removeAttribute(name)|删除数据|
|session.getSessionId()|不同的浏览器sessionId不同,会将sessionId存储到Cookie("JSESSIONID")|
|session.getAttributeNames()|获得所有存储数据的名称|
|seesion.setMaxInactiveInterval(秒)|设置session的有效时间，默认30分钟|
|session.getMaxInactiveInterval()|获得session有效时间|
|session.invalidate()|使此会话无效,销毁session,退出的时候调用|
|session.getSession(create)|true和getSession()一样 flase找不到返回null不会创建session|
|&lt;session-config&gt;&lt;session-timeout&gt;1&lt;/session-timeout&gt;&lt;/session-config&gt;|web.xml中配置,session有效时间 单位分钟|

```
//SessionDemo1
@Override
protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
    String name = req.getParameter("name");
    HttpSession session=req.getSession();
    session.setAttribute("name",name);
}
//SessionDemo2
@Override
protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
    resp.setContentType("text/html;charset=utf-8");
    HttpSession session=req.getSession();
    String name= (String) session.getAttribute("name");
    if(name!=null){
        System.out.println(name);
    }else {
        System.out.println("不能直接访问次资源");
    }
    resp.getWriter().println(name);
}
```
###### 购物车
```
//所有商品 ShowAllBooksServlet
protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
    resp.setContentType("text/html;charset=utf-8");
    PrintWriter out = resp.getWriter();
    out.println("本网站有以下好书<br/>");
    ArrayList<Book> books = BookService.findAllBooks();
    for(Book book:books){
        out.println(book.name+"\t\t<a href='"+req.getContextPath()+"/addCart?id="+book.id+"'>添加到购物车</a><br/>");
    }
    out.println("<a href='"+req.getContextPath()+"/showCart'>查看购物车</a>");
}

//添加购物车 AddCartServlet
protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
    resp.setContentType("text/html;charset=utf-8");
    PrintWriter out = resp.getWriter();
    String id=req.getParameter("id");
    HttpSession session = req.getSession();
    LinkedList<String> ids = (LinkedList<String>) session.getAttribute("cart");
    if(ids==null)
        ids=new LinkedList<>();
    if(ids.contains(id))
        ids.remove(id);
    ids.addFirst(id);
    session.setAttribute("cart",ids);
    out.println("添加购物车成功");
    resp.setHeader("refresh","1;url="+req.getContextPath()+"/showBooks");
}

//购物车商品 ShowCartServlet
protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
    HttpSession session = req.getSession();
    List<String> ids= (List<String>) session.getAttribute("cart");
    ArrayList<Book> books = BookService.findBookByIdsOrder(ids);
    resp.setContentType("text/html;charset=utf-8");
    PrintWriter out = resp.getWriter();
    out.println("购物车有以下商品<br/>");
    if(books==null||books.size()==0){
        out.println("购物车为空!");
        //resp.sendRedirect();
        resp.setHeader("refresh","2;url="+req.getContextPath()+"/showBooks");
        return;
    }
    for(Book book:books){
       out.println(book.name+"<br/>");
   }
    session.setMaxInactiveInterval(5);
}
```
## getSession()内部执行原理
1.获取名称为JSESSIONID的Cookie
2.没有这样的Cookie，创建一个新的HtppSession,分配唯一的SessionID,并且向客户端写一个名字为JSESSIONID=sessionId的Cookie
3.获取Cookie从根据ID查找HttpSession对象 （找到继续服务，找不到从2开始)

## Session的状态
1.创建
> 第一次访问动态资源就会创建 request.getSession()触发
2.活着
> 应用运行时活着
3.钝化(搁置),活化(激活)
>当内存溢出或者 服务器重启，服务器会序列化Session存盘这个过程叫钝化
>
>存盘路径:tomcat/work/Catalina/localhost/项目名称/Sessions.ser

## 验证验证码
###### login.jsp
```
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<html lang="en">
<head>
    <title>登录</title>
    <script type="text/javascript">
        function changeCode() {
            document.getElementsByTagName("img")[0].src="/codeServlet?time="+new Date().getTime();
        }

    </script>
</head>
<body>
    <%
        String msg = (String) request.getAttribute("msg");
        if(msg!=null)
            out.print(msg);
    %>
    <form action="/doLogin" method="post">
    用户名:<input type="text" name="username"><br/>
    密码:<input type="password" name="password"><br/>
        验证码:<input type="text" name="code"><img src="/codeServlet" onclick="changeCode()"><a href="javascript:changeCode()">看不清换一张</a><br/>
    <input type="submit" value="登录">
    </form>
</body>

</html>
```
###### CodeServlet
```
@Override
protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
    ValidateCode validateCode=new ValidateCode(110,25,4,9);
    HttpSession session = req.getSession();
    session.setAttribute("scode",validateCode.getCode());
    validateCode.write(resp.getOutputStream());
}
```
###### DoLogin
```
@Override
protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
    req.setCharacterEncoding("utf-8");
    resp.setContentType("text/html;charset=utf-8");
    PrintWriter out = resp.getWriter();
    String username=req.getParameter("username");
    String password=req.getParameter("password");
    String code=req.getParameter("code");
    String scode = (String) req.getSession().getAttribute("scode");
    if("tom".equals(username)&&"123".equals(password)){
        if (!code.equals(scode)){
            req.setAttribute("msg","验证码错误");
            req.getRequestDispatcher("login.jsp").forward(req,resp);
        }else {
            out.println("登陆成功");
        }
    }
}
```
## 客户端禁用Cookie后的会话数据保存
>方案一:在主页给出提示，请不要禁用您的Cookie
>方案二:URL重写，必须对网站所有地址重写
>http://url --> http://url;JSESSIONID=111;
>response.encodeUrl(url)
```
out.println("<a href='"+resp.encodeURL(req.getContextPath()+"/showCart")+"'>查看购物车</a>");
```
