---
layout: post
title: struts2
tags:
- java

categories: java
description: struts2
---
File failed to load: /extensions/MathZoom.js
## 三层架构和Struts2
表示层: M mode  V view  C contol
业务层:Service
持久层:Data Access Object
Struts2处在表现层，是表现层框架
###### struts2配置
```html
struts2
	|
	|--apps
		|
		|--struts-blank.war
				|
				|--WEB-INF/lib
					|
					|--asm-xxx.jar 基于子类动态代理的jar包
					|--commons-fileupliad-xx.jar  文件上传下载的jar包
					|--commons-io-xx.jar 对java.io的增强
					|--commons-lang-xx.jar 对java.lang包的增强
					|--commons-logging-xx.jar 日志增强jar
					|--freemarker-xx.jar 页面模板组件
					|--javassist-xx.jar jboss公司的关于字节码的一个开源项目
					|--log4j-xx.jar 日志开源组件
					|--ognl-xx.jar OGNL表达式的jar包
					|--struts2-core-xx.jar struts2的核心jar包
					|--xwork-core-xx.jar xwork的核心jar,也是struts2的核心jar包
```
###### 执行过程
```html
客户浏览器
	|
	|--启动Tomcat服务器
		|
		|--加载web.xml
			|
			|--加载初始化StrutsPrepareAndExecuteFilter
				|
			    |--加载struts.xml
				|   
				|--匹配action
				|	|
				|	|--找到后，实例化动作类
				|
				|--调用动作对应的方法,得到返回值
				|
				|--根据返回值，找到name对应的结果视图
```
###### struts2配置加载顺序
```html
struts2按如下顺序加载配置
	|--default-properties 该文件保存在struts2-core-xx.jar中org.apache.struts包里面
	|--struts-defaults.xml 该文件保存在struts2-core-xxx.jar中
	|--struts-plugin 该文件保存在struts2-xxx-xx.jar中
	|--struts.xml改文件是web应用默认的struts配置文件
	|--struts.properties该文件是struts的默认配置文件
	|--web.xml该文件是web应用的配置文件
后面的配置覆盖前面的配置
```
###### struts2 配置
```html
Package:定义一个struts的包按照面向对象的思想管理(分模块开发)
	|
	|--name属性:包的名称，在配置文件中唯一
	|
	|--extends属性:指定当前包的父包
	|
	|--abstract属性:把包声明为一个抽象包，抽象包就是用来被继承，没有action元素
	|
	|--namespace属性:名称空间。当指定了名称空间之后，访问路径就变成了了：
	|	  |			 访问路径 = =名称空间 + 动作名称
	|	  |			 默认值是""  
	|	  |
	|     |--http://localhost:8080/a/b/c.action
	|	  |		|
	|	  |		|--搜索所有package的namesapce,找/a/b
	|	  |	     	 |
	|	  |		  	 |--找到了:找动作名称(只查找动作名称)没有找到去默认的namespace里面找
	|	  |		  	 |--没找到:搜索package的namespace,找/a
	|	  |		  	 		|
	|	  |		  	 		|--找到了:找动作名称
	|	  |		  	 		|--没找到:搜索package的namespace,找/
	|	  
	|	  
	|--action元素:定义动作名称，动作类和动作方法的映射，以及当出现不同情况是前往指定的结果视图
		  |
		  |--name属性:动作名称.和请求url中的名称对应起来
		  |
		  |--class属性:指定动作类
		  |
		  |--method属性:指定要执行的动作方法
		  |
		  |--result元素:指定不同情况的结果视图
		  		|
		  		|--name属性：结果视图名称，默认值success,与动作方法的返回值对应，当一致时前往指定的jsp
		  		|
		  		|--type属性: 结果视图类型，默认值是dispatcher 转发
		  			 |
		  			 |--dispatcher 请求转发
		  			 |--redirect 重定向
		  			 |--chain 转发到另一个动作
		  			 |	  |
		  			 |	  |--转发同包(相同名称空间)的另一个动作
		  			 |	  |		|
		  			 |	  |		|--<result name="success" type="chain">actionName</result>
		  			 |	  |
		  			 |	  |--转发不同包的另一个动作
		  			 |			|
		  			 |			|--<result name="success" type="chain">
                	 |						<param name="namespace">struts</param>
                	 |						<param name="actionName">other_action</param>
           			 |				</result>
 					 |
		  			 |--redirectAction 重定向到另一个动作
		  			      |
		  			      |--重定向到同包的另一个动作
		  			      |--重定向到不同包的另一个动作
```
###### 示例
```xml
//web.xml
<!--配置struts的核心控制器,就是一个filter-->
<filter>
    <filter-name>struts2</filter-name>
    <filter-class>org.apache.struts2.dispatcher.ng.filter.StrutsPrepareAndExecuteFilter</filter-class>
    <init-param>
        <param-name>struts.action.extension</param-name>
        <param-value>abcd</param-value>
    </init-param>
</filter>
<filter-mapping>
    <filter-name>struts2</filter-name>
    <url-pattern>/*</url-pattern>
</filter-mapping>

//struts.xml

<constant name="struts.devMode" value="true"></constant>
<package name="p3" extends="struts-default" namespace="/struts">
    <action name="action2" class="com.itheima.web.action.Demo2Action" method="fun" >
        <result name="success">/success.jsp</result>
    </action>
</package>

//Demo2Action

public class Demo2Action {
    public String fun(){
        return "success";
    }
}
```
###### Action接口常量
|常量|备注|
|-----|------|
|SUCCESS|"success" 当执行成功后返回的|
|NONE|"none" 不返回任何结果视图 和return null是一样的|
|ERROR|"error" 当执行动作方法，出现异常后前往的指定位置|
|INPUT|"input" 数据回现|
|LOGIN|"login" 一般用于返回登陆页面|

###### 创建Action第二种方法
```javascript
//struts.xml
<action name="action3" class="com.itheima.web.action.Demo3Action">
    <result name="success">/success.jsp</result>
</action>

//Demo3Action
import com.opensymphony.xwork2.Action;
public class Demo3Action implements Action {
    @Override
    public String execute() throws Exception {
        return SUCCESS;
    }
}
```
###### 创建Action的第三种方式
```javascript
//开发中一般采用这种方式

//struts.xml
<action name="action4" class="com.itheima.web.action.Demo4Action">
    <result name="success">/success.jsp</result>
</action>

//Demo4Action
import com.opensymphony.xwork2.ActionSupport;
public class Demo4Action extends ActionSupport {
}
```
###### 修改设置默认action动作类
```xml
<package name="p2" extends="struts-default">
    <!--修改默认动作类-->
    <default-class-ref class="com.itheima.web.action.Demo4Action"></default-class-ref>
    <!--访问默认的动作类和动作方法的配置 默认的动作类是:ActionSupport.
        它是在struts-default.xml的配置文件中定义看-->
    <action name="defaultAction">
        <result name="success">/success.jsp</result>
    </action>
</package>
```
###### 原始配置方式
```javascript
//struts.xml
<package name="p2" extends="struts-default">
    <action name="addUser" class="com.itheima.web.action.UserAction" method="addUser">
        <result name="success">/addUser.jsp</result>
    </action>
    <action name="updateUser" class="com.itheima.web.action.UserAction" method="updateUser">
        <result name="success">/updateUser.jsp</result>
    </action>
    <action name="deleteUser" class="com.itheima.web.action.UserAction" method="deleteUser">
        <result name="success">/deleteUser.jsp</result>
    </action>
    <action name="findUser" class="com.itheima.web.action.UserAction" method="findUser">
        <result name="success">/findUser.jsp</result>
    </action>
</package>


//UserAction
public class UserAction extends ActionSupport{
    public String addUser(){
        System.out.println("添加用户");
        return SUCCESS;
    }
    public String updateUser(){
        System.out.println("修改用户");
        return SUCCESS;
    }
    public String deleteUser(){
        System.out.println("删除用户");
        return SUCCESS;
    }
    public String findUser(){
        System.out.println("查找用户");
        return SUCCESS;
    }
}


//userIndex.jsp
<a href="${pageContext.request.contextPath}/addUser.abcd">添加用户</a><br>
<a href="${pageContext.request.contextPath}/updateUser.abcd">修改用户</a><br/>
<a href="${pageContext.request.contextPath}/deleteUser.abcd">删除用户</a><br/>
<a href="${pageContext.request.contextPath}/findUser.abcd">查找用户</a>
```

###### 通配符配置action
```javascript
//index.jsp
<a href="${pageContext.request.contextPath}/add_User.abcd">添加用户</a><br>
<a href="${pageContext.request.contextPath}/update_User.abcd">修改用户</a><br/>
<a href="${pageContext.request.contextPath}/delete_User.abcd">删除用户</a><br/>
<a href="${pageContext.request.contextPath}/find_User.abcd">查找用户</a>

//struts.xml
<package name="p2" extends="struts-default">
    <!--使用通配符，配置动作方法
        *表示动作名称,当有何动作名称相匹配的时候可以用{出现的位置来代替}
    -->
    <action name="*_*" class="com.itheima.web.action.{2}Action" method="{1}{2}">
        <result name="success">/{1}{2}.jsp</result>
    </action>
</package>
```
###### 动态方法调用
```javascript
//userIndex.jsp
<!--动态方法调用
    动作名称!动作方法.action
    动作名称!动作方法
-->
<a href="${pageContext.request.contextPath}/user!addUser.abcd">添加用户</a><br>
<a href="${pageContext.request.contextPath}/user!updateUser.abcd">修改用户</a><br/>
<a href="${pageContext.request.contextPath}/user!deleteUser.abcd">删除用户</a><br/>
<a href="${pageContext.request.contextPath}/user!findUser.abcd">查找用户</a><br/>
</body>

//struts.xml
<struts>
    <!--开启动态方法调用-->
    <constant name="struts.enable.DynamicMethodInvocation" value="true"></constant>
     <package name="p2" extends="struts-default">
        <!--动态调用方法-->
        <action name="user" class="com.itheima.web.action.UserAction">
            <result name="success">/success.jsp</result>
        </action>
    </package>
</struts>
```
## 结果视图
###### 常见结果视图类型
```xml
<package name="p2" extends="struts-default">
    <!--重定向-->
    <action name="action5" class="com.itheima.web.action.Demo5Action">
        <result name="success" type="redirect">/success.jsp</result>
    </action>
    <!--转发同包的另一个动作-->
    <action name="action5_chain_1">
        <result name="success" type="chain">other_action</result>
    </action>
    <!--转发不同包的另一个动作-->
    <action name="action5_chain_2">
        <result name="success" type="chain">
            <param name="namespace">struts</param>
            <param name="actionName">other_action</param>
        </result>
    </action>
    <!--另一个动作-->
    <action name="other_action">
        <result name="success">/success.jsp</result>
    </action>
</package>
<package name="p3" extends="struts-default" namespace="/struts">
        <!--另一个动作-->
    <action name="other_action">
        <result name="success">/success.jsp</result>
    </action>
</package>
```
## 自定义结果视图
> 在包中配置的结果视图，只能在包和其子包中使用
> 在action内部的结果视图，是只能当前动作类使用
```javascript
自定义结果类型
	|
	|--创建一个继承StrutsResultSupport的实例，重写doExecute的方法
	|
	|--Servlet的中怎么写，doExecute中还怎么写
	|
	|--在struts.xml中配置
			|
			|--<package name="p4" extends="struts-default">
        			<result-types>
            			<result-type name="captcha" class="com.itheima.web.result.CAPTCHResult"></result-type>
        			</result-types>
       			    <action name="captchaAction">
            			<result name="success" type="captcha">
                			<param name="width">400</param>
                			<param name="height">200</param>
            			</result>
       				</action>
               </package>
```
```javascript
public class CAPTCHResult extends StrutsResultSupport {
    private int width;
    private int height;
    @Override
    protected void doExecute(String s, ActionInvocation actionInvocation) throws Exception {
        ValidateCode code = new ValidateCode(width, height, 4, 10);
        HttpServletResponse resp = ServletActionContext.getResponse();
        code.write(resp.getOutputStream());
    }

    public int getWidth() {
        return width;
    }

    public void setWidth(int width) {
        this.width = width;
    }

    public int getHeight() {
        return height;
    }

    public void setHeight(int height) {
        this.height = height;
    }
}

//struts.xml
<package name="p4" extends="struts-default">
    <result-types>
        <result-type name="captcha" class="com.itheima.web.result.CAPTCHResult"></result-type>
    </result-types>
    <action name="captchaAction">
        <result name="success" type="captcha">
            <param name="width">400</param>
            <param name="height">200</param>
        </result>
    </action>
</package>
```
###### 定义全局的结果视图
```xml
<package name="myDefault" extends="struts-default" abstract="true">
    <result-types>
        <result-type name="captcha" class="com.itheima.web.result.CAPTCHResult"></result-type>
    </result-types>
    <global-results>
        <!--结果视图的查找顺序，先找当前的，如果没有再找全局的-->
        <result name="success" type="captcha">
            <param name="width">400</param>
            <param name="height">200</param>
        </result>
    </global-results>
</package>

<package name="p4" extends="myDefault">
    <action name="captchaAction"></action>
</package>
```
## 获取ServletAPI
```java
/**
 * 获取ServletApi
 * 第一种方式:使用ServletActionContext 推荐
 * 第二种方式:使用是依赖注入的形式,把我们想要的对象注入进来
 *  是由一个拦截器为我们做的(ServletConfig)
 */
public class Demo6Action extends ActionSupport implements ServletRequestAware,ServletResponseAware,ServletContextAware {
    private HttpServletRequest req;
    private HttpServletResponse resp;
    private ServletContext application;
    @Override
    public String execute() throws Exception {
        ServletContext application = ServletActionContext.getServletContext();
        HttpServletRequest req = ServletActionContext.getRequest();
        HttpServletResponse resp = ServletActionContext.getResponse();
        HttpSession session = req.getSession();
        System.out.println(application);
        System.out.println(req);
        System.out.println(resp);
        System.out.println(session);

        //第二种方式
        System.out.println(this.application);
        System.out.println(this.req);
        System.out.println(this.resp);
        System.out.println(this.req.getSession());
        return null;
    }

    @Override
    public void setServletRequest(HttpServletRequest req) {
        this.req=req;
    }

    @Override
    public void setServletResponse(HttpServletResponse resp) {
        this.resp=resp;
    }

    @Override
    public void setServletContext(ServletContext application) {
        this.application=application;
    }
}
```
##
分文件编写框架配置文件
```xml
//struts.xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE struts PUBLIC
        "-//Apache Software Foundation//DTD Struts Configuration 2.3//EN"
        "http://struts.apache.org/dtds/struts-2.3.dtd">
<struts>
    <constant name="struts.devMode" value="true"></constant>
    <include file="struts_user.xml"></include>
    <include file="struts_role.xml"></include>
    <include file="struts_module.xml"></include>
</struts>


//struts_user.xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE struts PUBLIC
        "-//Apache Software Foundation//DTD Struts Configuration 2.3//EN"
        "http://struts.apache.org/dtds/struts-2.3.dtd">
<struts>
    <package name="p1" extends="struts_default" namespace="/user">
        <action name="addUser" class="com.itheima.web.action.UserAction" method="addUser"></action>
        <action name="updateUser" class="com.itheima.web.action.UserAction" method="updateUser"></action>
        <action name="deleteUser" class="com.itheima.web.action.UserAction" method="deleteUser"></action>
        <action name="findUser" class="com.itheima.web.action.UserAction" method="findUser"></action>
    </package>
</struts>
```
