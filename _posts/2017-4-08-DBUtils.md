---
layout: post
title: DBUtils
tags:
- java

categories: java
description: DBUtils
---
## 什么是DBUtils
> DBUtils是java编程中的数据库操作实用工具，小巧简单实用
> DBUtils封装了对JDBC的操作,简化了JDBC操作，可以少些代码
1.对于数据表的读操作，他可以把结果转换成List,Array,set的java集合
2.对于数据表的写操作，也变得很简单
3.可以使用数据源，使用JNDE,数据库连接池等技术来优化性能
## DBUuils的三个核心对象
+ QueryRunner类
query()查询
update() insert update delete
batch()批处理
+ ResultSetHandler接口
用于定义select 结果集
+ DBUtils类
关闭资源，事务管理
```html
使用步骤
   |
   |--导入jar包
   |	  |
   |	  |--commons-dbutil-1.4.jar		
   |
   |--创建QueryRunner对象
   |	  |
   |	  |--QueryRunner qr=new QueryRunner(C3P0Util.getDataSource()); 	
   |			|
   |			|--查询:List<T>list=qr.query(sql,ResultSetHandler,Object...params)  params:给?赋值
   |			|
   |			|--修改:qr.update(sql,Object...params) params:给sql中？赋值
   |			|
   |			|--批量:qr.batch(sql,Object[][]params) params:高纬执行的sql次数，低纬每条sql中？赋值
   |
   |
   |--ResultSetHandler
   |		 |
   |	     |--new ArrayHandler() 把每一行数据封装到Object[]里面
   |		 |
   |		 |--new ArrayListHandler() 将结果封装到List<Object[]>里面 每个Object[]封装一行数据
   |		 |
   |		 |--new ColumnListHandler(int index) 将每行第index列封装到List<Object>里面
   |		 |
   |		 |--new KeyedHandler(int index) 将每行数据封装成map,再将第index列作为key,map作为value封装成Map<Object, Map<String, Object>>		 
   |		 |
   |		 |--new MapHandler() 将一行的数据封装成Map<String, Object>
   |		 |
   |		 |--new MapListHandler() 将每行数据封装成map,再将所有的map放到list集合里面 List<Map<String, Object>>
   |		 |
   |		 |--new ScalarHandler(index) 单行第index列的数据
   |		 |
   |		 |--new BeanHandler<T>(T.class) 将一行数据封装成一个实体类 T
   |         |
   |		 |--new BeanListHandler<T>(T.class) 将每行数据封装成实体类存放到list集合 List<T>
   |				
   |
   |--使用DBUtils释放资源		
```
```java
@Test
public void testSelect1()throws Exception{
    QueryRunner qr=new QueryRunner(C3P0Util.getDataSource());
    List<User> list=qr.query("select * from users", new ResultSetHandler< ArrayList<User>>() {
        @Override
        public  ArrayList<User> handle(ResultSet resultSet) throws SQLException {
            ArrayList<User> users = new ArrayList<>();
            while ((resultSet.next())){
                User u = new User();
                u.setId(resultSet.getInt("id"));
                u.setName(resultSet.getString("name"));
                u.setBirthday(resultSet.getString("birthday"));
                u.setEmail(resultSet.getString("email"));
                u.setPassword(resultSet.getString("password"));
                users.add(u);
            }
            return users;
        }
    });
    for(User u:list){
        System.out.println(u);
    }

}
@Test
public void testSelect2()throws Exception{
    QueryRunner qr=new QueryRunner(C3P0Util.getDataSource());
    List<User>list=qr.query("select * from users where id =? and name = ?",new BeanListHandler<User>(User.class),8,"刘亦菲");
    for(User u:list){
        System.out.println(u);
    }
}
@Test
public void testInsert()throws Exception{
    QueryRunner qr=new QueryRunner(C3P0Util.getDataSource());
    qr.update("insert into users(name,password,email,birthday) values(?,?,?,?)","刘涛","123456","liutao@qq.com","2013-04-26");
}
@Test
public void testUpdate()throws Exception{
    QueryRunner qr=new QueryRunner(C3P0Util.getDataSource());
    qr.update("update users set name=? where id=?","赵丽颖",10);
}
@Test
public void testDelete()throws Exception{
    QueryRunner qr=new QueryRunner(C3P0Util.getDataSource());
    qr.update("delete from users where id=?",4);
}
@Test
public void testBatch()throws Exception{
    QueryRunner qr=new QueryRunner(C3P0Util.getDataSource());
    Object[][]params=new Object[10][];//高纬代表执行多少次
    for(int i=0;i<params.length;i++){
        params[i]=new Object[]{"朱茵"+i,"12345","zhuyin"+i+"@qq.com","2016-0"+i+"-1"+i};//给每次执行的sql中的?复制
    }
    qr.batch("insert into users(name,password,email,birthday) values(?,?,?,?)",params);
}
```
```java
public class TsetResultSetHandler {
    @Test
    public void test1()throws Exception {
        QueryRunner qr = new QueryRunner(C3P0Util.getDataSource());
        //ArrayHandler:把每一行数据封装到Object[]里面
        Object[] arr = qr.query("select * from users where id = ?", new ArrayHandler(), 16);
        System.out.println(Arrays.toString(arr));
    }
    @Test
    public void test2()throws Exception{
        QueryRunner qr=new QueryRunner(C3P0Util.getDataSource());
        //每个Object[]是一条数据
        List<Object[]> list = qr.query("select * from users", new ArrayListHandler());
        for(Object[]os:list){
            System.out.println(Arrays.toString(os));
        }
    }
    @Test
    public void test3()throws Exception{
        QueryRunner qr=new QueryRunner(C3P0Util.getDataSource());
        List<Object> list = qr.query("select name,password from users", new ColumnListHandler(2));
        for(Object o:list){
            System.out.println(o);
        }
    }
    @Test
    public void test4()throws  Exception{
        QueryRunner qr=new QueryRunner(C3P0Util.getDataSource());
        Map<Object, Map<String, Object>> maps = qr.query("select * from users", new KeyedHandler(1));
        for(Map.Entry<Object,Map<String,Object>> map:maps.entrySet()){
            System.out.println(map.getKey()+":"+map.getValue());
        }
    }
    @Test
    public void test5()throws Exception{
        QueryRunner qr=new QueryRunner(C3P0Util.getDataSource());
        Map<String, Object> map = qr.query("select * from users", new MapHandler());
        System.out.println(map);
    }
    @Test
    public void test6()throws Exception{
        QueryRunner qr=new QueryRunner(C3P0Util.getDataSource());
        List<Map<String, Object>> list = qr.query("select * from users", new MapListHandler());
        for(Map<String,Object> map:list){
            System.out.println(map);
        }
    }
    @Test
    public void test7()throws Exception{
        QueryRunner qr=new QueryRunner(C3P0Util.getDataSource());
        Object o = qr.query("select name,password from users where id=?", new ScalarHandler(1),8);
        System.out.println(o);
    }
    @Test
    public void test8()throws Exception{
        QueryRunner qr=new QueryRunner(C3P0Util.getDataSource());
        User u = qr.query("select * from users where id = ?", new BeanHandler<User>(User.class), 8);
        System.out.println(u);
    }
    @Test
    public void test9()throws Exception{
        QueryRunner qr=new QueryRunner(C3P0Util.getDataSource());
        List<User> list = qr.query("select * from users", new BeanListHandler<User>(User.class));
        for(User u:list){
            System.out.println(u);
        }
    }
}
```
## ThreadLocal 线程局部变量
> 里面有个 static的 map集合，map的key值是Thred.currentThread() 当前线程
> 同一个线程可以取到，不同的线程取不到
```java
ThreadLocal t1=new ThreadLocal();
t1.set("线程局部变量");
new Thread(){
    @Override
    public void run() {
        System.out.println(Thread.currentThread().getName()+":"+t1.get());
    }
}.start();
System.out.println(Thread.currentThread().getName()+":"+t1.get());
```
###### 转账
```java
//ManagerThreadLocal
public class ManagerThreadLocal {
    private static ThreadLocal<Connection>tl=new ThreadLocal<>();
    public static Connection getConnection(){
        Connection conn=tl.get();
        if(conn==null) {
            conn = C3P0Util.getConnection("day13");
            tl.set(conn);
        }
        return conn;
    }
    //开始事务
    public static void startTransacation(){
        try {
            getConnection().setAutoCommit(false);
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }
    //提交事务
    public static void commit(){
        try {
            getConnection().commit();
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }
    //回滚事务
    public static void rollback(){
        try {
            getConnection().rollback();
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }
    public static void release(){
        try {
            getConnection().close();
            tl.remove();
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }
}
//AccountDaoImpl
public class AccountDaoImpl implements AccountDao {
    @Override
    @Deprecated
    public void updateAccount(String fromName, String toName, double money) throws SQLException {
        QueryRunner qr=new QueryRunner(C3P0Util.getDataSource("day13"));
        qr.update("update account set money=money-? where name=?",money,fromName);
        qr.update("update account set money=money+? where name=?",money,toName);
    }

    @Override
    public void updateAccount(Account account) throws SQLException {
        QueryRunner qr=new QueryRunner();
        qr.update(ManagerThreadLocal.getConnection(),"update account set money=? where name =?",account.getMoney(),account.getName());
    }

    @Override
    public Account findAccountByName(String name) throws SQLException {
        QueryRunner qr=new QueryRunner();
        Account account = qr.query(ManagerThreadLocal.getConnection(), "select * from account where name=?", new BeanHandler<Account>(Account.class), name);
        return account;
    }
//AccountService
public class AccountServiceImpl implements AccountService {
    AccountDao ad=new AccountDaoImpl();
    @Override
    public void transfer(String fromName, String toName, double money) {
        //ad.updateAccount(fromName,toName,money);
        try {
            ManagerThreadLocal.startTransacation();
            Account fromAccount=ad.findAccountByName(fromName);
            Account toAccount=ad.findAccountByName(toName);
            fromAccount.setMoney(fromAccount.getMoney()-money);
            toAccount.setMoney(toAccount.getMoney()+money);
            ad.updateAccount(fromAccount);
            int i=10/0;
            ad.updateAccount(toAccount);
            ManagerThreadLocal.commit();
        } catch (Exception e) {
            e.printStackTrace();
                ManagerThreadLocal.rollback();
        }
        ManagerThreadLocal.release();
    }
}
//Test
public class Test {
    public static void main(String[] args)throws Exception {
        AccountService service=new AccountServiceImpl();
        service.transfer("aaa","bbb",100);
    }
}
```
