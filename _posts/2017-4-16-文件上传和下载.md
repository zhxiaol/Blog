---
layout: post
title: 文件上传和下载
tags:
- java

categories: java
description:文件上传和下载
---
## 文件上传
>前提条件:
> + 提供form表单，method必须是post
> + form表单的enctype必须是 multipart/form-data
> + 提供input type='file'类的上传输入域
##### enctype(encodingType)
> 告知服务器请求正文的MIME类型(文件类型，请求消息头:Content-type作用是一致的)
```
可选值
  |
  |--application/x-www-form-urlencode(默认)
  |					|
  |					|--正文:name=admin&password=123
  |					|--服务器获取数据:String name=request.getParameter("name")
  |
  |
  |--multipart/form-data
  |			|
  |			|--正文:multipart/form-data; boundary=----WebKitFormBoundaryuGq6WWODcJXyCkGv
  |			|		------WebKitFormBoundaryuGq6WWODcJXyCkGv
  |			|		Content-Disposition: form-data; name="name"
  |			|		跳跳
  |			|		------WebKitFormBoundaryuGq6WWODcJXyCkGv
  |			|		Content-Disposition: form-data; name="photo"; filename="头像.jpg"
  |     |   Content-Dispositionontent-Type: image/jpeg
  |     |   ------WebKitFormBoundaryuGq6WWODcJXyCkGv--
  |			|
  |			|
  |			|--服务器获取数据:req.getInputStrem
```

### fileupload
> fileupload是由apache的comons组件提供的上传组件，他最主要的工作就是帮我们解析request.getInputStrem()
> 核心类: DiskFileItemFactory、ServletFileUpload、FileItem。
```
FileUpload组件实现文件上传
        |
        |--导入相关jar包
        |       |
        |       |--commons-fileupload.jar
        |       |--commons-io.jar
        |
        |--判断encType类型
        |       |
        |       |--boolean isMultipart=ServletFileUpload.isMultipartContent(request)
        |
        |--创建工厂类DiskFileItemFactory对象:
        |       |
        |       |--DiskFileItemFactory factory=new DiskFileItemFactory()
        |                   |
        |                   |--factory.setRepository(new File("f://"));设置保存临时文件的目录 默认10kb
        |         
        |
        |--使用工厂创建解析器对象
        |       |
        |       |--ServletFileUpload fileUpload=new ServletFileUpload(factory)
        |                   |
        |                   |--fileUpload.setFileSizeMax(3*1024*1024);//单个不能大于3M
        |                   |--fileUpload.setSizeMax(6*1024*1024);//多个文件总大小不能大于6M
        |         
        |
        |--使用解析器来解析request对象：
        |       |
        |       |--List<FileItem> list=fileUploadRequest(request)
        |
        |--FileItem对象对应一个表单项
                |
                |--boolean isFormField() 是不是普通项
                |--getFieldName() 获得字段名
                |--getString() 获得字段value值
                |--getName() 得到文件名
                |--getContentType()获取文件上传类型:text/plain
                |--getSize() 获得上传文件大小
                |--getInputStream() 获取上传文件对象的输入流
                |--write(File) 把上传文件保存到指定文件中
                |--delete() 删除临时文件
```
###### 文件上传
```
public class UploadServlet2 extends HttpServlet {
    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        doGet(req,resp);
    }

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
       // req.setCharacterEncoding("utf-8");优先级不高
        resp.setContentType("text/html;charset=utf-8");
        boolean isMultipart = ServletFileUpload.isMultipartContent(req);
        if(isMultipart){
            DiskFileItemFactory factory = new DiskFileItemFactory();
            //factory.setRepository(new File("f://"));保存临时文件的目录
            ServletFileUpload fileUpload = new ServletFileUpload(factory);
            fileUpload.setHeaderEncoding("utf-8");//解决表单乱码问题
            try {
                //fileUpload.setFileSizeMax(3*1024*1024);//单个不能大于3M
                //fileUpload.setSizeMax(6*1024*1024);//多个文件总大小不能大于6M
                List<FileItem> list = fileUpload.parseRequest(req);
                for(FileItem item:list){
                    if(item.isFormField()){//普通表单项
                        processFormField(item);
                    }else {//上传表单项
                        processUploadField2(item);
                    }
                }
            } catch (Exception e){
                e.printStackTrace();
                resp.getWriter().println("文件不能大于3MB");
            }
        }
    }

    private void processUploadField2(FileItem item) throws Exception {
        String fileName=item.getName();//文件名
        if(fileName!=null) {//解决上传文件名带路径问题
            fileName = FilenameUtils.getName(fileName);
            //fileName=fileName.substring(fileName.lastIndexOf(File.separator)+1);
        }
        fileName= UUID.randomUUID()+"_"+fileName;//解决重名问题
        InputStream is = item.getInputStream();
        String directoryRealPath=this.getServletContext().getRealPath("/WEB-INF/upload");//解决上传可执行文件问题，该路径外部不可访问
        String childDirectory=makeChildDirecory(directoryRealPath);
        String childDirectory2=makeChildDirecory(directoryRealPath,fileName);
        File storeDirectory=new File(childDirectory2);
        if(!storeDirectory.exists())
            storeDirectory.mkdirs();
        File file=new File(storeDirectory,fileName);
        item.write(file);//自动删除临时文件

    }

    private void processUploadField(FileItem item) throws IOException {
        String fileName=item.getName();//文件名
        if(fileName!=null) {//解决上传文件名带路径问题
            fileName = FilenameUtils.getName(fileName);
            //fileName=fileName.substring(fileName.lastIndexOf(File.separator)+1);
        }
        fileName= UUID.randomUUID()+"_"+fileName;//解决重名问题
        InputStream is = item.getInputStream();
        String directoryRealPath=this.getServletContext().getRealPath("/WEB-INF/upload");//解决上传可执行文件问题，该路径外部不可访问
        String childDirectory=makeChildDirecory(directoryRealPath);
        String childDirectory2=makeChildDirecory(directoryRealPath,fileName);
        File storeDirectory=new File(childDirectory2);
        if(!storeDirectory.exists())
            storeDirectory.mkdirs();
        File file=new File(storeDirectory,fileName);
        FileOutputStream fos = new FileOutputStream(file);
        int len=0;
        byte[]arr=new byte[8192];
        while ((len=is.read(arr))!=-1){
            fos.write(arr,0,len);
        }
        item.delete();//删除临时文件
        fos.close();
    }
    //目录打散
    private String makeChildDirecory(String storeDirectory) {
        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
        String date = sdf.format(new Date());
        return storeDirectory+"/"+date;
    }
    //目录打散
    private String makeChildDirecory(String storeDirectory,String fileName){
        int hashCode = fileName.hashCode();
        String code = Integer.toHexString(hashCode);
        return storeDirectory+"/"+code.charAt(0)+"/"+code.charAt(1);
    }


    private void processFormField(FileItem item) throws UnsupportedEncodingException {
        String name = item.getFieldName();//字段名
        String value=item.getString("utf-8");
        System.out.println(name+"="+value);

    }
}
```
