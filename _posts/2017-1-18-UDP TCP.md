---
layout: post
title: UDP TCP
tags:
- java

categories: java
description:
---


## UDP和TCP
UDP  面向无连接，数据不安全，速度快。不区分客户端与服务端。
TCP   面向连接（三次握手），数据安全，速度略低。分为客户端和服务端。
	  三次握手: 客户端先向服务端发起请求, 服务端响应请求, 传输数据




## UDP传输
```java
public static void main(String[] args) throws Exception {
    new Receiver().start();
    new Sender().start();
}
static class Receiver extends Thread{
    @Override
    public void run() {
        try {
            DatagramSocket server=new DatagramSocket(6666);
            DatagramPacket packet=new DatagramPacket(new byte[8192],8192);
            while(true){
                server.receive(packet);
                String ip = packet.getAddress().getHostAddress();
                int port = packet.getPort();
                byte[] data = packet.getData();
                int len = packet.getLength();
                System.out.println(ip+" : "+port+" "+new String(data,0,len));
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
static class Sender extends Thread{
    @Override
    public void run() {
        try {
            Scanner sc=new Scanner(System.in);
            DatagramSocket socket=new DatagramSocket();
            while(true){
                String line = sc.nextLine();
                if("quit".equals(line)){
                    break;
                }
                byte[] arr = line.getBytes();
                DatagramPacket packet=new DatagramPacket(arr,arr.length, InetAddress.getByName("127.0.0.1"),6666);
                socket.send(packet);
            }
            socket.close();
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```
###### UDP聊天
```java
public class Test extends Frame{
    private DatagramSocket socket;
    private BufferedWriter bw;
    private TextField ip;
    private Button send;
    private Button log;
    private Button clear;
    private Button shake;
    private TextArea viewText;
    private TextArea sendText;

    public Test(){
        init();
        southPanel();
        centerPanel();
        event();
    }

    private void event() {
        this.addWindowListener(new WindowAdapter() {
            @Override
            public void windowClosing(WindowEvent e) {
                try {
                    socket.close();
                    bw.close();
                    System.exit(0);
                } catch (IOException e1) {
                    e1.printStackTrace();
                }
            }
        });
        send.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                try {
                    send(sendText.getText().getBytes(),ip.getText().toString());
                } catch (IOException e1) {
                    e1.printStackTrace();
                }
            }
        });
        sendText.addKeyListener(new KeyAdapter() {
            @Override
            public void keyReleased(KeyEvent e) {
                if(e.getKeyCode()==KeyEvent.VK_ENTER&&e.isControlDown()){
                    try {
                        send(sendText.getText().getBytes(),ip.getText().toString());
                    } catch (IOException e1) {
                        e1.printStackTrace();
                    }
                }
            }
        });
        log.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                try {
                    logFile();
                } catch (IOException e1) {
                    e1.printStackTrace();
                }
            }
        });
        clear.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                viewText.setText("");
            }
        });
        shake.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                try {
                    send(new byte[]{-1},ip.getText().toString());
                } catch (IOException e1) {
                    e1.printStackTrace();
                }
            }
        });
    }

    private void logFile() throws IOException {
        bw.flush();
        FileInputStream fis=new FileInputStream("config.txt");
        ByteOutputStream bos=new ByteOutputStream();
        byte[]arr=new byte[8192];
        int len;
        while((len=fis.read(arr))!=-1){
            bos.write(arr,0,len);
        }
        String s = bos.toString();
        viewText.setText(s);

    }

    private void send(byte[] arr, String ip) throws IOException {
        DatagramPacket packet=new DatagramPacket(arr,arr.length, InetAddress.getByName(ip),9999);
        socket.send(packet);
        ip=ip.trim().length()==0?"255.255.255.255":ip;
        if(arr.length==1&&arr[0]==-1){

        }else {
            String time=getCurrentTime();
            String s=time+" 我对"+(ip.equals("255.255.255.255")?"所有人":ip)+"说\n"+new String(arr)+"\n";
            viewText.append(s);
            bw.write(s);
            sendText.setText("");
        }
    }

    private void centerPanel() {
        Panel panel=new Panel();
        viewText=new TextArea();
        sendText=new TextArea(5,1);
        panel.setLayout(new BorderLayout());
        panel.add(viewText,BorderLayout.CENTER);
        panel.add(sendText,BorderLayout.SOUTH);
        this.add(panel,BorderLayout.CENTER);
        viewText.setEnabled(false);
        viewText.setBackground(Color.WHITE);
        viewText.setFont(new Font("",Font.PLAIN,15));
        sendText.setFont(new Font("",Font.PLAIN,15));
    }

    private void southPanel() {
        Panel panel=new Panel();
        ip = new TextField(15);
        ip.setText("127.0.0.1");
        send = new Button("发送");
        log = new Button("记录");
        clear = new Button("清除");
        shake =new Button("震动");
        panel.add(ip);
        panel.add(send);
        panel.add(log);
        panel.add(clear);
        panel.add(shake);
        this.add(panel,BorderLayout.SOUTH);
    }

    private void init() {
        this.setSize(500,600);
        this.setLocation(500,50);
        new Receiver().start();
        try {
            socket=new DatagramSocket();
            bw=new BufferedWriter(new FileWriter("config.txt",true));
        } catch (IOException e) {
            e.printStackTrace();
        }
        this.setVisible(true);
    }

    public static void main(String[] args) throws Exception {
        new Test();
    }

    public String getCurrentTime() {
        SimpleDateFormat sdf=new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
        return sdf.format(new Date());
    }
    public class Receiver extends Thread{
        @Override
        public void run() {
            try {
                DatagramSocket server=new DatagramSocket(9999);
                DatagramPacket packet=new DatagramPacket(new byte[8192],8192);
                while(true){
                    server.receive(packet);
                    String ip = packet.getAddress().getHostAddress();
                    byte[] data = packet.getData();
                    int len = packet.getLength();
                    if(data.length==0&&data[0]==-1){
                        shake();
                        continue;
                    }else {
                        String time=getCurrentTime();
                        String s=time+" "+ip+"对我说\n"+new String(data,0,len)+"\n";
                        bw.write(s);
                        viewText.append(s);
                    }
                }
            } catch (Exception e) {
                e.printStackTrace();
            }
        }


    }
    public  void shake() {
        int x=this.getLocation().x;
        int y=this.getLocation().y;
        for(int i=0;i<20;i++){
            try {
                this.setLocation(x+20,y+20);
                Thread.sleep(20);
                this.setLocation(x+20,y-20);
                Thread.sleep(20);
                this.setLocation(x-20,y-20);
                Thread.sleep(20);
                this.setLocation(x-20,y-20);
                Thread.sleep(20);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}
```


## TCP协议
创建Socket连接服务端(指定ip地址,端口号)通过ip地址找对应的服务器
创建ServerSocket(需要指定端口号)调用ServerSocket的accept()方法接收一个客户端请求
```java
public static class Client extends Thread{
    @Override
    public void run() {
        try {
            Socket socket=new Socket("127.0.0.1",12345);
            BufferedReader br=new BufferedReader(new InputStreamReader(socket.getInputStream()));
            PrintStream ps=new PrintStream(socket.getOutputStream());
            System.out.println("客户端收到:"+br.readLine());
            ps.println("挖掘机哪家强？");
            System.out.println("客户端收到:"+br.readLine());
            socket.close();
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
public static class Server extends Thread{
    @Override
    public void run() {
        try {
            final ServerSocket server=new ServerSocket(12345);
            while(true){
                final Socket socket = server.accept();
                new Thread(){
                    @Override
                    public void run() {
                        try {
                            BufferedReader br=new BufferedReader(new InputStreamReader(socket.getInputStream()));
                            PrintStream ps=new PrintStream(socket.getOutputStream());
                            ps.println("欢迎访问服务器");
                            System.out.println("服务器收到:"+br.readLine());
                            ps.println("山东技校找蓝翔");
                            socket.close();
                        } catch (IOException e) {
                            e.printStackTrace();
                        }
                    }
                }.start();
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```
## 练习 文件上传
###### 客服端
```java
public static void main(String[] args) throws IOException {
    File file = getFile();
    Socket socket=new Socket("127.0.0.1",12345);
    BufferedReader br=new BufferedReader(new InputStreamReader(socket.getInputStream()));
    PrintStream ps= new PrintStream(socket.getOutputStream());
    ps.println(file.getName());
    String result = br.readLine();
    if("存在".equals(result)){
        System.out.println("您上传的文件已经存在，请不要重复上传");
        socket.close();
        return;
    }
    FileInputStream fis=new FileInputStream(file);
    byte[]arr=new byte[8192];
    int len;
    while((len=fis.read(arr))!=-1){
        ps.write(arr,0,len);
    }
    fis.close();
    socket.close();
}
public static File getFile(){
    Scanner sc=new Scanner(System.in);
    System.out.println("请输入要上传的文件路径");
    while(true){
        String line = sc.nextLine();
        File file = new File(line);
        if(!file.exists()){
            System.out.println("您录入的文件路径不存在");
        }else if(file.isDirectory()) {
            System.out.println("您录入的是文件夹路径");
        }else {
            return file;
        }

    }

}
```
###### 服务器
```java
ServerSocket server=new ServerSocket(12345);
System.out.println("服务器启动，绑定12345端口号");
while(true){
    final Socket socket=server.accept();
    new Thread(){
        @Override
        public void run() {
            try {
                InputStream is = socket.getInputStream();
                BufferedReader br=new BufferedReader(new InputStreamReader(is));
                PrintStream ps=new PrintStream(socket.getOutputStream());
                String name=br.readLine();
                File dir=new File("update");
                dir.mkdirs();
                File file=new File(dir,name);
                if(file.exists()){
                    ps.println("存在");
                    socket.close();
                    return;
                }else {
                    ps.println("不存在");
                }
                FileOutputStream fos=new FileOutputStream(file);
                byte[]arr=new byte[8192];
                int len;
                while((len=is.read(arr))!=-1){
                    fos.write(arr,0,len);
                }
                fos.close();
                socket.close();
            } catch (IOException e) {
                e.printStackTrace();
            }

        }
    }.start();
}
```
