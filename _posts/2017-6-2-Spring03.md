---
layout: post
title: Spring 事务管理
tags:
- java

categories: java
description:Spring 事务管理
---


## 事务管理介绍
###### 导入jar包
> transaction  -->  tx


## 三个顶级接口

> PlatformTransactionManager  平台事务管理器，spring要管理事务，必须使用事务管理器
	进行事务配置时，必须配置事务管理器。
> TransactionDefinition：事务详情（事务定义、事务属性），spring用于确定事务具体详情，
	例如：隔离级别、是否只读、超时时间 等
	进行事务配置时，必须配置详情。spring将配置项封装到该对象实例。
> TransactionStatus：事务状态，spring用于记录当前事务运行状态。例如：是否有保存点，事务是否完成。
	spring底层根据状态进行相应操作。

PlatformTransactionManager  事务管理器
> 导入jar包：需要时平台事务管理器的实现类


> 常见的事务管理器
	DataSourceTransactionManager  ，jdbc开发时事务管理器，采用JdbcTemplate
	HibernateTransactionManager，hibernate开发时事务管理器，整合hibernate


###### api详解
> TransactionStatus getTransaction(TransactionDefinition definition) ，事务管理器 通过“事务详情”，获得“事务状态”，从而管理事务。
> void commit(TransactionStatus status)  根据状态提交
> void rollback(TransactionStatus status) 根据状态回滚



## TransactionDefinition

> 传播行为：在两个业务之间如何共享事务。

> PROPAGATION_REQUIRED , required , 必须  【默认值】
	支持当前事务，A如果有事务，B将使用该事务。
	如果A没有事务，B将创建一个新的事务。
> PROPAGATION_SUPPORTS ，supports ，支持
	支持当前事务，A如果有事务，B将使用该事务。
	如果A没有事务，B将以非事务执行。
> PROPAGATION_MANDATORY，mandatory ，强制
	支持当前事务，A如果有事务，B将使用该事务。
	如果A没有事务，B将抛异常。
> PROPAGATION_REQUIRES_NEW ， requires_new ，必须新的
	如果A有事务，将A的事务挂起，B创建一个新的事务
	如果A没有事务，B创建一个新的事务
> PROPAGATION_NOT_SUPPORTED ，not_supported ,不支持
	如果A有事务，将A的事务挂起，B将以非事务执行
	如果A没有事务，B将以非事务执行
> PROPAGATION_NEVER ，never，从不
	如果A有事务，B将抛异常
	如果A没有事务，B将以非事务执行
> PROPAGATION_NESTED ，nested ，嵌套
	A和B底层采用保存点机制，形成嵌套事务。

掌握：PROPAGATION_REQUIRED、PROPAGATION_REQUIRES_NEW、PROPAGATION_NESTED




## 案例：转账
```
public interface AccountService {
    //转账
    public void transfer(String outer, String inner, int money);
}

public interface AccountDao {
    //汇款
    void out(String outer, int money);
    //收款
    void in(String in, int money);
}

//applicationContext.xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:aop="http://www.springframework.org/schema/aop"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/context
       http://www.springframework.org/schema/context/spring-context.xsd">
    <bean id="dataSource" class="com.mchange.v2.c3p0.ComboPooledDataSource">
        <property name="driverClass" value="com.mysql.jdbc.Driver"/>
        <property name="jdbcUrl" value="jdbc:mysql://localhost:3306/ee19_spring_day03?characterEncoding=utf-8"/>
        <property name="user" value="root"/>
        <property name="password" value="root"/>
    </bean>
    <bean id="accountDao" class="com.itheima.dao.impl.AccountDaoImpl">
        <property name="dataSource" ref="dataSource"/>
    </bean>
    <bean id="accountService" class="com.itheima.service.impl.AccountServiceImpl">
        <property name="dao" ref="accountDao"/>
    </bean>
</beans>

public class TestApp {
    @Test
    public void demo01(){
        String path="applicationContext.xml";
        ApplicationContext appcontext = new ClassPathXmlApplicationContext(path);
        AccountService service= (AccountService) appcontext.getBean("accountService");
        service.transfer("jack","rose",1000);
    }
}
```


## 手动管理事
> spring底层使用 TransactionTemplate 事务模板进行操作。
> 操作
```
1.service 需要获得 TransactionTemplate
2.spring 配置模板，并注入给service
3.模板需要注入事务管理器
4.配置事务管理器：DataSourceTransactionManager ，需要注入DataSource
```

```
public class AccountDaoImpl extends JdbcDaoSupport implements AccountDao {
    @Override
    public void out(String outer, int money) {
        this.getJdbcTemplate().update("update account set money = money - ? where username = ?",money,outer);
    }

    @Override
    public void in(String in, int money) {
        this.getJdbcTemplate().update("update account set money = money + ? where username = ?",money,in);
    }
}




//applicationContext.xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:aop="http://www.springframework.org/schema/aop"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/context
       http://www.springframework.org/schema/context/spring-context.xsd">
    <bean id="dataSource" class="com.mchange.v2.c3p0.ComboPooledDataSource">
        <property name="driverClass" value="com.mysql.jdbc.Driver"/>
        <property name="jdbcUrl" value="jdbc:mysql://localhost:3306/ee19_spring_day03?characterEncoding=utf-8"/>
        <property name="user" value="root"/>
        <property name="password" value="root"/>
    </bean>
    <bean id="accountDao" class="com.itheima.dao.impl.AccountDaoImpl">
        <property name="dataSource" ref="dataSource"/>
    </bean>
    <bean id="accountService" class="com.itheima.service.impl.AccountServiceImpl">
        <property name="dao" ref="accountDao"/>
        <property name="transactionTemplate" ref="transactionTemplate"/>
    </bean>
    <!--创建模板-->
    <bean id="transactionTemplate" class="org.springframework.transaction.support.TransactionTemplate">
        <property name="transactionManager" ref="transactionManager"/>
    </bean>
    <!--配置事务管理器 事务从Connection获得，连接从连接池获取-->
    <bean id="transactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
        <property name="dataSource" ref="dataSource"/>
    </bean>
</beans>
```

## 工厂bean 生成代理：半自动
> spring提供 管理事务的代理工厂bean TransactionProxyFactoryBean
> getBean() 获得代理对象
> spring 配置一个代理

```
public class AccountDaoImpl extends JdbcDaoSupport implements AccountDao {
    @Override
    public void out(String outer, int money) {
        this.getJdbcTemplate().update("update account set money = money - ? where username = ?",money,outer);
    }
    @Override
    public void in(String in, int money) {
        this.getJdbcTemplate().update("update account set money = money + ? where username = ?",money,in);
    }
}


public class AccountServiceImpl implements AccountService {
    private AccountDao dao;

    public void setDao(AccountDao dao) {
        this.dao = dao;
    }

    @Override
    public void transfer(String outer, String inner, int money) {
        dao.out(outer,money);
        int i=10/0;
        dao.in(inner,money);
    }
}


public class TestApp {
    @Test
    public void demo01(){
        String path="applicationContext.xml";
        ApplicationContext appcontext = new ClassPathXmlApplicationContext(path);
        AccountService service= (AccountService) appcontext.getBean("proxyAccountService");
        service.transfer("jack","ross",1000);
    }
}


//beans.xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:aop="http://www.springframework.org/schema/aop"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/context
       http://www.springframework.org/schema/context/spring-context.xsd">
    <bean id="dataSource" class="com.mchange.v2.c3p0.ComboPooledDataSource">
        <property name="driverClass" value="com.mysql.jdbc.Driver"/>
        <property name="jdbcUrl" value="jdbc:mysql://localhost:3306/ee19_spring_day03?characterEncoding=utf-8"/>
        <property name="user" value="root"/>
        <property name="password" value="root"/>
    </bean>
    <bean id="accountDao" class="com.itheima.dao.impl.AccountDaoImpl">
        <property name="dataSource" ref="dataSource"/>
    </bean>
    <bean id="accountService" class="com.itheima.service.impl.AccountServiceImpl">
        <property name="dao" ref="accountDao"/>
    </bean>
    <bean id="transactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
        <property name="dataSource" ref="dataSource"/>
    </bean>
    <!--service代理对象
    target:目标类
    proxyInterfaces:接口
    transactionAttributes:事务属性(事务详情)
    prop key:那些方法使用当前事务
    prop text:用于事务详情
    格式:PROPAGATION,ISOLATION,readOnly,-Exception,+Exception
         传播行为       事务级别   是否只读   异常回滚   异常提交
    -->
    <bean id="proxyAccountService" class="org.springframework.transaction.interceptor.TransactionProxyFactoryBean">
        <property name="target" ref="accountService"/>
        <property name="proxyInterfaces" value="com.itheima.service.AccountService"/>
        <property name="transactionManager" ref="transactionManager"/>
        <property name="transactionAttributes">
            <props>
                <prop key="transfer">PROPAGATION_REQUIRED,ISOLATION_DEFAULT,+ java.lang.ArithmeticException</prop>
            </props>
        </property>
    </bean>
</beans>
```
## AOP配置事务
```
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:tx="http://www.springframework.org/schema/tx"
       xmlns:aop="http://www.springframework.org/schema/aop"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/context
       http://www.springframework.org/schema/context/spring-context.xsd
       http://www.springframework.org/schema/aop
       http://www.springframework.org/schema/aop/spring-aop.xsd
       http://www.springframework.org/schema/tx
       http://www.springframework.org/schema/tx/spring-tx.xsd">
    <bean id="dataSource" class="com.mchange.v2.c3p0.ComboPooledDataSource">
        <property name="driverClass" value="com.mysql.jdbc.Driver"/>
        <property name="jdbcUrl" value="jdbc:mysql://localhost:3306/ee19_spring_day03?characterEncoding=utf-8"/>
        <property name="user" value="root"/>
        <property name="password" value="root"/>
    </bean>
    <bean id="accountDao" class="com.itheima.dao.impl.AccountDaoImpl">
        <property name="dataSource" ref="dataSource"/>
    </bean>
    <bean id="accountService" class="com.itheima.service.impl.AccountServiceImpl">
        <property name="dao" ref="accountDao"/>
    </bean>
    <bean id="txManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
        <property name="dataSource" ref="dataSource"/>
    </bean>
    <!--事务通知 在aop筛选基础上，对ABC三个确定使用什么样的事务，列如:AC读写，B只读
       <tx:attributes> 用于配置事务详情(属性)
       <tx:method name=""/> 详情具体配置
       propagation:传播行为
       isolation:隔离级别
   -->
    <tx:advice id="txAdvice" transaction-manager="txManager">
        <tx:attributes>
            <tx:method name="transfer" propagation="REQUIRED" isolation="DEFAULT" />
        </tx:attributes>
    </tx:advice>
    <aop:config >
        <aop:advisor advice-ref="txAdvice" pointcut="execution(* com.itheima.service..*.*(..))"/>
    </aop:config>
</beans>
```





## AOP配置基于注解【掌握】
> 1.配置事务管理器，将并事务管理器交予spring
> 2.在目标类或目标方法添加注解即可 @Transactional

```

<!-- 4 事务管理 -->
	<!-- 4.1 事务管理器 -->
	<bean id="txManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
		<property name="dataSource" ref="dataSource"></property>
	</bean>
	<!-- 4.2 将管理器交予spring
		* transaction-manager 配置事务管理器
		* proxy-target-class
			true ： 底层强制使用cglib 代理
	-->
	<tx:annotation-driven transaction-manager="txManager"/>

2.3.5.2	service 层
@Transactional
public class AccountServiceImpl implements AccountService {

2.3.5.3	事务详情配置


@Transactional(propagation=Propagation.REQUIRED , isolation = Isolation.DEFAULT)
public class AccountServiceImpl implements AccountService {

```

## 整合Junit
>	导入jar包
	基本 ：4+1
	测试：spring-test...jar

> 1.让Junit通知spring加载配置文件
> 2.让spring容器自动进行注入

```
@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(locations = "classpath:applicationContext.xml")
public class TestApp {
    @Autowired
    private AccountService accountService;//与junit整合，不需要spring xml扫描配置
    @Test
    public void demo01(){
        accountService.transfer("jack","ross",1000);
    }
}
```
## 整合web
```

0.导入jar包
	spring-web.jar

1.tomcat启动加载配置文件
	servlet --> init(ServletConfig) --> <load-on-startup>2
	filter --> init(FilterConfig)  --> web.xml注册过滤器自动调用初始化
	listener --> ServletContextListener --> servletContext对象监听【】
	spring提供监听器 ContextLoaderListener  --> web.xml  <listener><listener-class>....
		如果只配置监听器，默认加载xml位置：/WEB-INF/applicationContext.xml

2.确定配置文件位置，通过系统初始化参数
	ServletContext 初始化参数 web.xml  
		<context-param>
			<param-name>contextConfigLocation
			<param-value>classpath:applicationContext.xml

  <!-- 确定配置文件位置 -->
  <context-param>
  	<param-name>contextConfigLocation</param-name>
  	<param-value>classpath:applicationContext.xml</param-value>
  </context-param>

  <!-- 配置spring 监听器，加载xml配置文件 -->
  <listener>
  	<listener-class>org.springframework.web.context.ContextLoaderListener</listener-class>
  </listener>

3.从servletContext作用域 获得spring容器 （了解）
	// 从application作用域（ServletContext）获得spring容器
		//方式1： 手动从作用域获取
		ApplicationContext applicationContext =
				(ApplicationContext) this.getServletContext().getAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE);
		//方式2：通过工具获取
		ApplicationContext apppApplicationContext2 =
				WebApplicationContextUtils.getWebApplicationContext(this.getServletContext());		

```


## SSH整合
######	jar整合
struts：2.3.15.3
hibernate : 3.6.10
spring: 3.2.0

###### struts
```
struts-2.3.15.3\apps\struts2-blank\WEB-INF\lib
模板技术  ，一般用于页面静态化
freemarker：扩展名：*.ftl
velocity ：扩展名  *.vm
```




###### spring
```
基础：4+1 ， beans、core、context、expression ， commons-logging (struts已经导入)
AOP：aop联盟、spring aop 、aspect规范、spring aspect
db：jdbc、tx
测试：test
web开发：spring web

驱动：mysql
连接池：c3p0

整合hibernate：spring orm

```


###### hibernate

```
hibernate3.jar			核心
 \lib\required			必须

\lib\jpa				jpa规范 （java persistent api 持久api），hibernate注解开发 @Entity @Id 等

整合log4j
	导入 log4j...jar (struts已经导入)
	整合（过渡）：slf4j-log4j12-1.7.5.jar

二级缓存
	核心：ehcache-1.5.0.jar
	依赖：
		backport-util-concurrent-2.1.jar
		commons-logging  (存在)
```

######整合包
```
spring整合hibernate： spring orm
struts 整合spring：struts2-spring-plugin-2.3.15.3.jar
```

删除重复jar包





5.2	spring整合hibernate：有hibernate.cfg.xml
5.2.1	创建表
create table t_user(
  id int primary key auto_increment,
  username varchar(50),
  password varchar(32),
  age int
);

## PO 类

```

//javabean
public class User {
	private Integer id;
	private String username;
	private String password;
	private Integer age;
//映射文件
<!DOCTYPE hibernate-mapping PUBLIC
    "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
    "http://www.hibernate.org/dtd/hibernate-mapping-3.0.dtd">
<hibernate-mapping>
	<class name="com.itheima.domain.User" table="t_user">
		<id name="id">
			<generator class="native"></generator>
		</id>
		<property name="username"></property>
		<property name="password"></property>
		<property name="age"></property>
	</class>

</hibernate-mapping>

//dao层
//spring提供 HibernateTemplate 用于操作PO对象，类似Hibernate Session对象。

public class UserDaoImpl implements UserDao {

	//需要spring注入模板
	private HibernateTemplate hibernateTemplate;
	public void setHibernateTemplate(HibernateTemplate hibernateTemplate) {
		this.hibernateTemplate = hibernateTemplate;
	}

	@Override
	public void save(User user) {
		this.hibernateTemplate.save(user);
	}

}

//service层

public class UserServiceImpl implements UserService {

	private UserDao userDao;
	public void setUserDao(UserDao userDao) {
		this.userDao = userDao;
	}
	@Override
	public void register(User user) {
		userDao.save(user);
	}

}



// hibernate.cfg.xml
<session-factory>
		<!-- 1基本4项 -->
		<property name="hibernate.connection.driver_class">com.mysql.jdbc.Driver</property>
		<property name="hibernate.connection.url">jdbc:mysql:///ee19_spring_day03</property>
		<property name="hibernate.connection.username">root</property>
		<property name="hibernate.connection.password">1234</property>

		<!-- 2 配置方言 -->
		<property name="hibernate.dialect">org.hibernate.dialect.MySQL5Dialect</property>

		<!-- 3 sql语句 -->
		<property name="hibernate.show_sql">true</property>
		<property name="hibernate.format_sql">true</property>

		<!-- 4 自动生成表(一般没用) -->
		<property name="hibernate.hbm2ddl.auto">update</property>

		<!-- 5本地线程绑定 -->
		<property name="hibernate.current_session_context_class">thread</property>

		<!-- 导入映射文件 -->
		<mapping resource="com/itheima/domain/User.hbm.xml"/>

	</session-factory>

//applicationContext.xml
//	添加命名空间
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:aop="http://www.springframework.org/schema/aop"
       xmlns:tx="http://www.springframework.org/schema/tx"
       xmlns:context="http://www.springframework.org/schema/context"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
       					   http://www.springframework.org/schema/beans/spring-beans.xsd
       					   http://www.springframework.org/schema/tx
       					   http://www.springframework.org/schema/tx/spring-tx.xsd
       					   http://www.springframework.org/schema/aop
       					   http://www.springframework.org/schema/aop/spring-aop.xsd
       					   http://www.springframework.org/schema/context
       					   http://www.springframework.org/schema/context/spring-context.xsd">

//加载hibernate配置文件
<!-- 1 加载hibenrate.cfg.xml 获得SessionFactory
		* configLocation确定配置文件位置
	-->
	<bean id="sessionFactory" class="org.springframework.orm.hibernate3.LocalSessionFactoryBean">
		<property name="configLocation" value="classpath:hibernate.cfg.xml"></property>
	</bean>

	<!-- 2创建模板
		* 底层使用session，session 有sessionFactory获得
	-->
	<bean id="hibernateTemplate" class="org.springframework.orm.hibernate3.HibernateTemplate">
		<property name="sessionFactory" ref="sessionFactory"></property>
	</bean>

//dao和service
<!-- 3 dao -->
	<bean id="userDao" class="com.itheima.dao.impl.UserDaoImpl">
		<property name="hibernateTemplate" ref="hibernateTemplate"></property>
	</bean>

	<!-- 4 service -->
	<bean id="userService" class="com.itheima.service.impl.UserServiceImpl">
		<property name="userDao" ref="userDao"></property>
	</bean>

<!-- 5 事务管理 -->
	<!-- 5.1 事务管理器 ：HibernateTransactionManager -->
	<bean id="txManager" class="org.springframework.orm.hibernate3.HibernateTransactionManager" >
		<property name="sessionFactory" ref="sessionFactory"></property>
	</bean>
	<!-- 5.2 事务详情 ，给ABC进行具体事务设置 -->
	<tx:advice id="txAdvice" transaction-manager="txManager">
		<tx:attributes>
			<tx:method name="register"/>
		</tx:attributes>
	</tx:advice>
	<!-- 5.3 AOP编程，ABCD 筛选 ＡＢＣ  -->
	<aop:config>
		<aop:advisor advice-ref="txAdvice" pointcut="execution(* com.itheima.service..*.*(..))"/>
	</aop:config>

// 测试
@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(locations="classpath:applicationContext.xml")
public class TestApp {

	@Autowired
	private UserService userService;

	@Test
	public void demo01(){
		User user = new User();
		user.setUsername("jack");
		user.setPassword("1234");
		user.setAge(18);

		userService.register(user);
	}
}
```


###### spring整合hibernate：没有hibernate.cfg.xml 【】
> 删除hibernate.cfg.xml文件，但需要保存文件内容，将其配置spring中
> 修改dao层，继承HibernateDaoSupport

```
// 修改spring，配置SessionFactory
<!-- 1.1加载properties文件 -->
	<!-- 1.2 配置数据源 -->
	<bean id="dataSource" class="com.mchange.v2.c3p0.ComboPooledDataSource">
		<property name="driverClass" value="com.mysql.jdbc.Driver"></property>
		<property name="jdbcUrl" value="jdbc:mysql:///ee19_spring_day03"></property>
		<property name="user" value="root"></property>
		<property name="password" value="1234"></property>
	</bean>

	<!-- 1.3配置 LocalSessionFactoryBean，获得SessionFactory
		* configLocation确定配置文件位置
			<property name="configLocation" value="classpath:hibernate.cfg.xml"></property>
		1)dataSource 数据源
		2)hibernateProperties hibernate其他配置项
		3) 导入映射文件
			mappingLocations ，确定映射文件位置，需要“classpath:” ,支持通配符 【】
				<property name="mappingLocations" value="classpath:com/itheima/domain/User.hbm.xml"></property>
				<property name="mappingLocations" value="classpath:com/itheima/domain/*.hbm.xml"></property>
			mappingResources ，加载执行映射文件，从src下开始 。不支持通配符*
				<property name="mappingResources" value="com/itheima/domain/User.hbm.xml"></property>
			mappingDirectoryLocations ，加载指定目录下的，所有配置文件
				<property name="mappingDirectoryLocations" value="classpath:com/itheima/domain/"></property>
			mappingJarLocations ， 从jar包中获得映射文件
	-->
	<bean id="sessionFactory" class="org.springframework.orm.hibernate3.LocalSessionFactoryBean">
		<property name="dataSource" ref="dataSource"></property>
		<property name="hibernateProperties">
			<props>
				<prop key="hibernate.dialect">org.hibernate.dialect.MySQL5Dialect</prop>
				<prop key="hibernate.show_sql">true</prop>
				<prop key="hibernate.format_sql">true</prop>
				<prop key="hibernate.hbm2ddl.auto">update</prop>
				<prop key="hibernate.current_session_context_class">thread</prop>
			</props>
		</property>
		<property name="mappingLocations" value="classpath:com/itheima/domain/*.hbm.xml"></property>
	</bean>


// 修改dao，使用HibernateDaoSupport
// 继承HibernateDaoSupport
// 底层需要SessionFactory，自动创建HibernateTemplate模板
public class UserDaoImpl extends HibernateDaoSupport implements UserDao {

	@Override
	public void save(User user) {
		this.getHibernateTemplate().save(user);
	}

}
// spring 删除模板，给dao注入SessionFactory
	<!-- 3 dao -->
	<bean id="userDao" class="com.itheima.dao.impl.UserDaoImpl">
		<property name="sessionFactory" ref="sessionFactory"></property>
	</bean>
```



##	struts整合spring：spring创建action

```
1.编写action类，并将其配置给spring ，spring可以注入service
2.编写struts.xml
3.表单jsp页面
4.web.xml 配置
	1.确定配置文件contextConfigLocation
	2.配置监听器 ContextLoaderListener
	3.配置前端控制器 StrutsPrepareAndExecuteFitler

// action类
// 通用
public class UserAction extends ActionSupport implements ModelDriven<User> {

	//1 封装数据
	private User user = new User();

	@Override
	public User getModel() {
		return user;
	}

	//2 service
	private UserService userService;
	public void setUserService(UserService userService) {
		this.userService = userService;
	}

// 功能
/**
	 * 注册
	 * @return
	 */
	public String register(){
		userService.register(user);
		return "success";
	}

// spring配置
<!-- 6 配置action -->
	<bean id="userAction" class="com.itheima.web.action.UserAction" scope="prototype">
		<property name="userService" ref="userService"></property>
	</bean>

//	struts配置
<struts>
	<!-- 开发模式 -->
    <constant name="struts.devMode" value="true" />

    <package name="default" namespace="/" extends="struts-default">
    	<!-- 底层自动从spring容器中通过名称获得内容， getBean("userAction") -->
    	<action name="userAction_*" class="userAction" method="{1}">
    		<result name="success">/messag.jsp</result>
    	</action>
    </package>
</struts>

//	jsp表单
<form action="${pageContext.request.contextPath}/userAction_register" method="post">
		用户名：<input type="text" name="username"/> <br/>
		密码：<input type="password" name="password"/> <br/>
		年龄：<input type="text" name="age"/> <br/>
		<input type="submit" />
	</form>

// 配置web.xml
<!-- 1 确定spring xml位置 -->
  <context-param>
  	<param-name>contextConfigLocation</param-name>
  	<param-value>classpath:applicationContext.xml</param-value>
  </context-param>
  <!-- 2 spring监听器 -->
  <listener>
  	<listener-class>org.springframework.web.context.ContextLoaderListener</listener-class>
  </listener>
  <!-- 3 struts 前端控制器 -->
  <filter>
  	<filter-name>struts2</filter-name>
  	<filter-class>org.apache.struts2.dispatcher.ng.filter.StrutsPrepareAndExecuteFilter</filter-class>
  </filter>
  <filter-mapping>
  	<filter-name>struts2</filter-name>
  	<url-pattern>/*</url-pattern>
  </filter-mapping>

//	struts整合spring：struts创建action
//	删除spring action配置
//	struts <action class="全限定类名">

<package name="default" namespace="/" extends="struts-default">
    	<!-- 底层自动从spring容器中通过名称获得内容， getBean("userAction") -->
    	<action name="userAction_*" class="com.itheima.web.action.UserAction" method="{1}">
    		<result name="success">/messag.jsp</result>
    	</action>
```   



##	struts整合spring：struts创建action
```
	删除spring action配置
	struts <action class="全限定类名">

<package name="default" namespace="/" extends="struts-default">
    	<!-- 底层自动从spring容器中通过名称获得内容， getBean("userAction") -->
    	<action name="userAction_*" class="com.itheima.web.action.UserAction" method="{1}">
    		<result name="success">/messag.jsp</result>
    	</action>
    </package>

	要求：Action类中，必须提供service名称与 spring配置文件一致。（如果名称一样，将自动注入）


分析：
1. struts 配置文件
	default.properties  ,常量配置文件
	struts-default.xml ，默认核心配置文件
	struts-plugins.xml ，插件配置文件
	struts.xml，自定义核心配置文件
	常量的使用，后面配置项，将覆盖前面的。
2.default.properties  ，此配置文件中确定 按照【名称】自动注入
	/org/apache/struts2/default.properties

3. struts-plugins.xml ,struts整合spring

		<constant name="struts.objectFactory" value="spring" />
	struts的action将有spring创建

总结，之后action有spring创建，并按照名称自动注入

```
