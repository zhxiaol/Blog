---
layout: post
title: javaweb设计模式和案例
tags:
- java

categories: java
description: javaweb设计模式和案例
---
一、JavaWeb开发模式
> C/S:客户端/服务器(胖客户端)
> B/S:浏览器/服务器(瘦客户端)
```html
开发模式
   |
   |--Model1模式	(过时)
   |	  |
   |	  |--jsp+javabean
   |
   |
   |
   |--Model2模式(MVC)
   		 |
   		 |--jsp+servlet+javabean


Modle层
  |
  |--JavaBean 普通类实体bean(无參构造、私有属性、公共的getter和setter方法)

View层
  |
  |--jsp

Control层
  |
  |---  
  	 |- Servlet表示层
  	 |	   |						    	
  	 |-	   |--Service业务层			    
  	 |				|					
  	 |-			    |--DAO(Data Access Object)数据访问层	    		
  	 |
  	 |-分层思想-强内聚，弱耦合 	

```
## 用户的登陆和注册
```javascript
//index.jsp
<head>
  <title>首页</title>
</head>
<body>
  <c:if test="${ empty u}">
  <a href="login.jsp">登陆</a>
  <a href="reg.jsp">注册</a>
  </c:if>
  <c:if test="${ not empty u}">
      欢迎您:${u.name}  <a href="${pageContext.request.contextPath}/loginOutServlet">注销</a>
  </c:if>
</body>

//----------------------------------------------------------------------------------------------
//login.jsp
<head>
    <title>登录</title>
</head>
<body>
    ${msg}
    <form action="${pageContext.request.contextPath}/loginServlet" method="post">
        用户名:<input type="text" name="name"><br/>
        密码:<input type="password" name="password"><br/>
        <input type="submit" value="登陆">
    </form>
</body>
//----------------------------------------------------------------------------------------------
//reg.jsp
<head>
    <title>注册</title>
</head>
<body>
    <form method="post" action="${pageContext.request.contextPath}/regservlet">
        用户名:<input type="text" name="name" value="${uf.name}">${uf.msg.name }${error}<br/>
        密码:<input type="password" name="password">${uf.msg.password}<br/>
        确认密码:<input type="password" name="repassword">${uf.msg.repassword}<br/>
        邮箱:<input type="text" name="email" value="${uf.email}">${uf.msg.email}<br/>
        生日:<input type="text" name="birthday" value="${uf.birthday}">${uf.msg.birthday}<br/>
        <input type="submit" value="注册">
    </form>
</body>
//----------------------------------------------------------------------------------------------
//UserFrom
public class UserFrom {
    private int id;
    private String name;
    private String password;
    private String repassword;
    private String email;
    private String birthday;
    private Map<String,String> msg=new HashMap<>();
    public boolean validate(){
        if("".equals(name)){
            msg.put("name","用户名不能为空");
        }else if(!name.matches("\\w{3,8}")){
            msg.put("name","用户名为3-8的字符组成");
        }
        if("".equals(password)){
            msg.put("password","密码不能为空");
        }else if(!password.matches("\\d{3,8}")){
            msg.put("password","密码为3-8的数字组成");
        }
        if(!password.equals(repassword)){
            msg.put("repassword","2次密码不一致");
        }
        if("".equals(email)){
            msg.put("email","邮箱不能为空");
        }else if(!email.matches("\\b^['_a-z0-9-\\+]+(\\.['_a-z0-9-\\+]+)*@[a-z0-9-]+(\\.[a-z0-9-]+)*\\.([a-z]{2}|aero|arpa|asia|biz|com|coop|edu|gov|info|int|jobs|mil|mobi|museum|name|nato|net|org|pro|tel|travel|xxx)$\\b")){
            msg.put("email","邮箱格式不正确");
        }
        if("".equals(birthday)){
            msg.put("birthday","生日不能为空");
        }else {
            SimpleDateFormat sdf=new SimpleDateFormat("yyy-MM-dd");
            try {
                sdf.parse(birthday);
            } catch (ParseException e) {
                e.printStackTrace();
                msg.put("birthday","生日格式不正确");
            }
        }
        return msg.isEmpty();
    }
//----------------------------------------------------------------------------------------------
//LoginServlet
protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
    req.setCharacterEncoding("utf-8");
    resp.setContentType("text/html;charset=utf");
    User u = new User();
    try {
        BeanUtils.populate(u,req.getParameterMap());
        UserService service = new UserServiceImpl();
        User user = service.login(u);
        if(user!=null) {
            req.getSession().setAttribute("u", user);
            req.getRequestDispatcher("/index.jsp").forward(req, resp);
        }else {
            resp.sendRedirect(req.getContextPath()+"/login.jsp");
        }
    } catch (Exception e) {
        e.printStackTrace();
        req.setAttribute("msg",e.getMessage());
        req.getRequestDispatcher(req.getContextPath()+"/login.jsp").forward(req,resp);
    }

}
/----------------------------------------------------------------------------------------------
//RegistServlet
protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
    req.setCharacterEncoding("utf-8");
    resp.setContentType("text/html;charset=utf-8");
    UserFrom from=new UserFrom();
    try {
        BeanUtils.populate(from,req.getParameterMap());
    } catch (Exception e) {
        e.printStackTrace();
    }
    if(!from.validate()){//验证不通过
        req.setAttribute("uf",from);
        req.getRequestDispatcher(req.getContextPath()+"/reg.jsp").forward(req,resp);
        return;
    }
    User u=new User();
    try {
        ConvertUtils.register(new Converter() {
            @Override
            public Object convert(Class type, Object value) {
                if(value instanceof String) {
                    SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
                    try {
                        return sdf.parse((String)value);
                    } catch (ParseException e) {
                        e.printStackTrace();
                    }
                }
                return null;
            }
        },Date.class);
        BeanUtils.populate(u,req.getParameterMap());
    } catch (Exception e) {
        e.printStackTrace();
    }
    UserService service=new UserServiceImpl();
    try {
        service.findUserByName(u.getName());
        service.rigest(u);
        resp.getWriter().println("注册成功!1秒跳到主页");
        resp.setHeader("refresh","1,url="+req.getContextPath()+"/index.jsp");
    } catch (UserExistException e) {
        e.printStackTrace();
        req.setAttribute("error","用户名已存在");
        req.getRequestDispatcher(req.getContextPath()+"/reg.jsp").forward(req,resp);
    }catch (Exception e) {
        e.printStackTrace();
    }
}
/----------------------------------------------------------------------------------------------
//LoginOutServlet
protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
    req.getSession().removeAttribute("u");
    resp.sendRedirect(req.getContextPath()+"/index.jsp");
}
/----------------------------------------------------------------------------------------------
//UserServiceImpl
public class UserServiceImpl implements UserService {
    UserDao dao=new UserDaoImpl();
    @Override
    public void rigest(User u) throws Exception {
        dao.addUser(u);
    }

    @Override
    public User login(User u) throws Exception {
        User user = dao.findUser(u);
        if(user==null)
            throw new UserException("用户名或者密码不正确");
        return user;
    }

    @Override
    public boolean findUserByName(String name) throws Exception {
        boolean b = dao.findUserByName(name);
        if(b){
            throw new UserExistException("用户已存在");
        }
        return b;
    }
}
/----------------------------------------------------------------------------------------------
//UserDaoImpl
public class UserDaoImpl implements UserDao{
    @Override
    public void addUser(User u) throws Exception {
        Connection conn = DBUtils.getConnection();
        String sql="insert into users values(?,?,?,?,?)";
        PreparedStatement ps=conn.prepareStatement(sql);
        ps.setInt(1,u.getId());
        ps.setString(2,u.getName());
        ps.setString(3,u.getPassword());
        ps.setString(4,u.getEmail());
        SimpleDateFormat sdf=new SimpleDateFormat("yyyy-MM-dd");
        ps.setString(5,sdf.format(u.getBirthday()));
        ps.executeUpdate();
        DBUtils.close(null,ps,conn);
    }

    @Override
    public User findUser(User u) throws Exception {
        Connection conn = DBUtils.getConnection();
        PreparedStatement ps=conn.prepareStatement("select * from users where name=? and password=?");
        ps.setString(1,u.getName());
        ps.setString(2,u.getPassword());
        ResultSet rs=ps.executeQuery();
        User user=null;
        if(rs.next()){
            user=new User();
            user.setId(rs.getInt("id"));
            user.setName(rs.getString("name"));
            user.setPassword(rs.getString("password"));
            user.setEmail(rs.getString("email"));
            user.setBirthday(rs.getDate("birthday"));
        }
        DBUtils.close(rs,ps,conn);
        return user;
    }

    @Override
    public boolean findUserByName(String name) throws Exception {
        Connection conn=DBUtils.getConnection();
        PreparedStatement ps=conn.prepareStatement("select * from users where name = ?");
        ps.setString(1,name);
        ResultSet rs=ps.executeQuery();
        if(rs.next()){
            DBUtils.close(rs,ps,conn);
            return true;
        }
        DBUtils.close(rs,ps,conn);
        return false;
    }
}
/----------------------------------------------------------------------------------------------
//DBUtils
public class DBUtils {
    private final static String  url;
    private final static String user;
    private final static String password;
    static {
        ResourceBundle rb=ResourceBundle.getBundle("dbinfo");
        url=rb.getString("url");
        user=rb.getString("user");
        password=rb.getString("password");
        String clazz=rb.getString("classDriver");
        try {
            Class.forName(clazz);
        } catch (ClassNotFoundException e) {
            e.printStackTrace();
        }
    }
    public static Connection getConnection()throws Exception{
        return DriverManager.getConnection(url,user,password);
    }
    public static void close(ResultSet rs, Statement stmt,Connection conn){
        try{
            if(rs!=null)
                rs.close();
        }catch (Exception e){
            e.printStackTrace();
        }finally {
            try {
                if (stmt != null)
                    stmt.close();
            }catch (Exception e){
                e.printStackTrace();
            }finally {
                try{
                    if(conn!=null)
                        conn.close();
                }catch (Exception e){
                    e.printStackTrace();
                }
            }
        }
    }

}
```
