---
layout: post
title: hibernate log4j和二级缓存
tags:
- java

categories: java
description: hibernate log4j和二级缓存
---
## Hibernate中的log4j配置
1. 添加jar包 slf4j-log4j12-xx.jar log4j-1.2.16.jar
1. 添加log4j.properties设置
## Hibernate中配置一对一
###### 外键的方式
```java
public class Address {
    private Integer id;
    private String name;
    private Company company;
}
//Address.hbm.xml
<!--unique 外键唯一-->
<many-to-one name="company" class="Company" column="cid" unique="true"/>

public class Company {
    private Integer id;
    private String name;
    private Address address;
}

//Company.hbm.xml
<!--配置一对-->
<!--one to one 默认使用主键同步策略完成-->
<!--property-ref 指定company一对一关联时指向那个属性-->
<one-to-one name="address" class="Address" property-ref="company"></one-to-one>


//Demo1
//保存一对一
@Test
public void fun1(){
    Session session = HibernateUtil.openSession();
    Transaction ts = session.beginTransaction();
    Company company = new Company();
    company.setName("传智播客");
    Address address = new Address();
    address.setName("金燕龙");
    //在一对一使用外键时，外键所在的才能维护关系，另一方无法维护关系
    address.setCompany(company);
    session.save(company);
    session.save(address);

    ts.commit();
    session.close();
}
@Test
public void fun2(){
    Session session = HibernateUtil.openSession();
    Transaction ts = session.beginTransaction();
    Company c = (Company) session.get(Company.class, 1);
    System.out.println(c);
    ts.commit();
    session.close();
}
```

###### 主键同步
```java
//Address.hbm.xml
<id name="id" column="id" type="int">
    <!--foreign既是主键又是外键-->
    <generator class="foreign">
        <!--作为外键时引用那个属性-->
        <param name="property">company</param>
    </generator>
</id>

<!--constrained主键约束-->
<one-to-one name="company" class="Company" constrained="true"></one-to-one>


//company.hbm.xml
<one-to-one name="address" class="Address" ></one-to-one>
```

## 二级缓存
> 级别:transactional(事务型) read-write(读写型) nostrict-read-write(非常严格的读写型)  read-only(只读型)
> 应用场景:很少被修改，不是很重要，经常被读取。

## eacache
```html
eacache使用步骤
	|
	|--导入jar包
	|	 |
	|	 |--backport-util-concurrent-2.1.jar 依赖
	|	 |--commons-loggin-1.1.1.jar 依赖
	|    |--ehcache-1.5.0.jar 核心
	|
	|--开启二级缓存(hibernate.cfg.xml中)
	|	 |
	|	 |--<property name="hibernate.cache.provider_class">org.hibernate.cache.EhCacheProvider</property>
	|	 |--<property name="hibernate.cache.use_second_level_cache">true</property>
	|
	|
	|--确定缓存内容(hibernate.cfg.xml中)
		 |
		 |--<class-cache class="Customer" usage="read-only"></class-cache>
```

###### 二级缓存:类缓存

```java
//hibernate.cfg.xml
<!--配置二级缓存-->
<property name="hibernate.cache.provider_class">org.hibernate.cache.EhCacheProvider</property>
<property name="hibernate.cache.use_second_level_cache">true</property>
<mapping resource="com/itheima/domain/Customer_hbm.xml"></mapping>
<mapping resource="com/itheima/domain/Order_hbm.xml"></mapping>
<class-cache class="com.itheima.domain.Customer" usage="read-only"></class-cache>
<class-cache class="com.itheima.domain.Order" usage="read-only"></class-cache>

//类缓存
@Test
public void fun1(){
    Session session = HibernateUtil.openSession();
    Transaction ts = session.beginTransaction();
    Customer c1 = (Customer) session.get(Customer.class, 1);
    session.clear();//清空一级缓存
    Customer c2 = (Customer) session.get(Customer.class, 1);
    System.out.println(c1==c2);//false 二级缓存数据并不是以对象形式缓存。缓存的对象的散列
    ts.commit();
    session.close();
}
```

###### 二级缓存:集合缓存
```java
//Hibernate.cfg.xml
<!--集合缓存配置-->
<collection-cache collection="com.itheima.domain.Customer.orders" usage="read-only"></collection-cache>

//集合缓存
@Test
public void fun1(){
    Session session = HibernateUtil.openSession();
    Transaction ts = session.beginTransaction();
    Customer c1 = (Customer) session.get(Customer.class, 1);
    for(Order o:c1.getOrders()){
        System.out.println(o.getName());
    }
    session.clear();
    Customer c2 = (Customer) session.get(Customer.class, 1);
    for(Order o:c2.getOrders()){
        System.out.println(o.getName());
    }
    ts.commit();
    session.close();
}
```
###### 二级缓存:查询缓存(HQL缓存)
```java
//Hibernate.cfg.xml
<!--开启查询缓存-->
<property name="hibernate.cache.use_query_cache">true</property>

//HQL查询缓存
@Test
public void fun1(){
    Session session = HibernateUtil.openSession();
    Transaction ts = session.beginTransaction();
    Query query = session.createQuery("from Customer ");
    //使用二级缓存，查询时先从二级缓存中去结果，如果取不到执行语句将结果放到二级缓存中
    query.setCacheable(true);
    List<Customer> list = query.list();
    session.clear();
    Query query2 = session.createQuery("from Customer ");
    query2.setCacheable(true);
    List list2 = query2.list();
    ts.commit();
    session.close();
}
```

###### 时间戳区
> 记录的是表和最后操作的时间
> 判断二级缓存的时效性
```java
//时间戳区
@Test
public void fun1(){
    Session session = HibernateUtil.openSession();
    Transaction ts = session.beginTransaction();
    Customer c1 = (Customer) session.get(Customer.class, 1);
    session.createQuery("update Customer  set name =:name where id=:id")
            .setString("name","rose").setInteger("id",1)
            .executeUpdate();
    session.clear();
    Customer c2 = (Customer) session.get(Customer.class, 1);
    ts.commit();
    session.close();
}
```

## ehcache二级缓存配置
> ehcache-1.5.0.jar 中 ehcache-failsafe.xml 复制到src下改名ehcache.xml
```html
maxElementsInMemory="10000"  内存最大数
eternal="false"  是否永久（内存常驻留）
timeToIdleSeconds="120" 最多空闲多少秒
timeToLiveSeconds="120" 最多存活多少秒
overflowToDisk="true"  内存满了，是否写入到硬盘
maxElementsOnDisk="10000000"  硬盘最大数
diskPersistent="false"  关闭JVM，是否将内存保存硬盘中
diskExpiryThreadIntervalSeconds="120"  轮询
memoryStoreEvictionPolicy="LRU" 移出策略 LRU最近最少使用 LFU最不常用 FIFO先进先出
```

```xml
<ehcache xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../config/ehcache.xsd">
    <!--缓存路径-->
    <diskStore path="java.io.tmpdir"/>
    <defaultCache
            maxElementsInMemory="10000"
            eternal="false"
            timeToIdleSeconds="120"
            timeToLiveSeconds="120"
            overflowToDisk="true"
            maxElementsOnDisk="10000000"
            diskPersistent="false"
            diskExpiryThreadIntervalSeconds="120"
            memoryStoreEvictionPolicy="LRU"
            />

</ehcache>
```
