---
layout: post
title: Oracle01
tags:
- java

categories: java
description: Oracle01
---
查询10和20号部门的员工
```sql

1. select * from emp where deptno in (10,20);
2. select * from emp where deptno=10 or deptno=20;
3. 集合运算
   select * from emp where deptno=10
     加上
   select * from emp where deptno=20

select * from emp where deptno=10
 2  union
 3  select * from emp where deptno=20;

select deptno,job,sum(sal) from emp group by rollup(deptno,job);
```

```sql
注意的问题：
1.参与运算的各个集合必须列数相同且类型一致
2. 采用第一个集合作为最后的表头
3. order by 永远在最后
4. 括号
```
```sql
 select deptno,job,sum(sal) from emp group by deptno,job
 2   union
 3   select deptno,to_char(null),sum(sal) from emp group by deptno
 4   union
 5   select to_number(null),to_char(null),sum(sal) from emp;

 break on deptno skip 2
```




SQL 优化 5. 尽量不要使用集合运算 SQL执行时间
```sql
set timing on
select deptno,job,sum(sal) from emp group by rollup(deptno,job);

select deptno,job,sum(sal) from emp group by deptno,job
  2   union
  3   select deptno,to_char(null),sum(sal) from emp group by deptno
  4   union
  5   select to_number(null),to_char(null),sum(sal) from emp;
```




rownum 行号
```sql
select rownum,empno,ename,sal from emp;

 select rownum,empno,ename,sal
  2  from emp
  3  where rownum<=3
  4  order by sal desc;
```

关于行号(rownum只能使用 < <=; 不能使用> >=)
```sql

1. rownum永远按照默认的顺序生成
2. rownum只能使用 < <=; 不能使用> >=

select rownum,empno,ename,sal from emp order by sal desc;
```




第一题
```sql
select rownum,empno,ename,sal
 2  from (select * from emp order by sal desc)
 3  where rownum<=3;
```





分页

```sql
 select *
 2   from     (select rownum r,e1.*
 3     from (select * from emp order by sal) e1
 4     where rownum <=8
 5    )
 6   where r >=5;

```
临时表
```sql
临时表:1. create global temporary table *****
       2. 自动创建: order by
       特点：当事务或者会话结束的时候，表中的数据自动删除
       create global temporary table test2
         2  (tid number,tname varchar2(20))
         3  on commit delete rows;
```

第二题
```sql
select e.empno,e.ename,e.sal,d.avgsal
 2  from emp e,(select deptno,avg(sal) avgsal from emp group by deptno) d
 3  where e.deptno=d.deptno and e.sal > d.avgsal;
```



相关子查询：将主查询中的值 作为参数传递给子查询
```sql
select empno,ename,sal,(select avg(sal) from emp where deptno=e.deptno) avgsal
 2  from emp e
 3  where sal > (select avg(sal) from emp where deptno=e.deptno);
```




第三题
```sql
select count(*) Total,

       sum(if 是81年 then +1 else +0) "1981",

from emp;

```



行转列 wm_concat(varchar2) 组函数
```sql
select deptno,wm_concat(ename) nameslist
 2  from emp
 3  group by deptno;

 col nameslist for a60

 select deptno,wm_concat(ename) nameslist
   2  from emp
   3  group by deptno;
```



查询工资比SCOTT高的员工信息
```sql
1. SCOTT的工资
select sal from emp where ename='SCOTT';

2. 比3000高的员工
set linesize 200
select * from emp where sal > 3000;
```

子查询所要解决的问题： 不能一步求解
```sql
select *
 2  from emp
 3  where sal > (select sal
 4               from emp
 5               where ename='SCOTT');
```
注意的问题：
```

1. 括号
2. 合理的书写风格
3. 可以在where  select having from后面 都可以使用子查询
4. 不可以在group by后面使用子查询
5. 强调from后面的子查询
6. 主查询和子查询可以不是同一张表；只要子查询返回的结果 主查询可以使用 即可
7. 一般不在子查询中排序；但在top-n分析问题中，必须对子查询排序
8. 一般先执行子查询，再执行主查询；但相关子查询例外
9. 单行子查询只能使用单行操作符；多行子查询只能使用多行操作符
10.子查询中的null
```
在where  select having from后面 都可以使用子查询
```sql
select empno,ename,sal,(select job from emp where empno=7839) 第四列
 2  from emp;
```


强调from后面的子查询(查询员工信息：员工号  姓名 月薪)
```sql
select *
 2  from (select empno,ename,sal from emp);
```



查询员工信息：员工号  姓名 月薪 年薪
```sql
 1  select *
 2* from (select empno,ename,sal,sal*12 annsal from emp)
```

子查询和单表查询性能
```
思考:
select empno,ename,sal,sal*12 annsal from emp;
select * from (select empno,ename,sal,sal*12 annsal from emp);
性能一样
```
主查询和子查询可以不是同一张表；只要子查询返回的结果 主查询可以使用 即可--查询部门名称是SALES的员工
```sql
select *
 2  from emp
 3  where deptno=(select deptno from dept where dname='SALES');

 select e.*
   2  from emp e,dept d
   3  where e.deptno=d.deptno and d.dname='SALES';
```
SQL 优化 4. 尽量使用多表查询


in 在集合中--查询部门名称是SALES和ACCOUNTING的员工
```sql
select *
 2  from emp
 3  where deptno in (select deptno from dept where dname='SALES' or dname='ACCOUNTING');
```



any: 和集合中的任意一个值比较--查询工资比30号部门任意一个员工高的员工信息
```sql
select *
 2  from emp
 3  where sal > any (select sal from emp where deptno=30);

 select *
   2  from emp
   3  where sal > (select min(sal) from emp where deptno=30)
```






all 和集合中的所有值比较--查询工资比30号部门所有员工高的员工信息
```sql
select *
 2  from emp
 3  where sal > all (select sal from emp where deptno=30);


select *
   2  from emp
   3* where sal > (select max(sal) from emp where deptno=30)
```


多行子查询中的null not in (10,20,null)

```sql
查询不是老板的员工
select *
 2  from emp
 3  where empno not in (select mgr from emp);
 未选定行

查询是老板的员工
select *
 2  from emp
 3  where empno in (select mgr from emp);

select *
   2  from emp
   3  where empno not in (select mgr from emp where mgr is not null);
```

分页--oracle·ÖÒ³(Pageing Query)
```sql
select *
from  (select rownum r,e1.*
   from (select * from emp order by sal) e1
   where rownum <=8
  )
where r >=5;
```

```sql
select count(*) Total,
  2         sum(decode(to_char(hiredate,'yyyy'),'1980',1,0)) "1980",
  3         sum(decode(to_char(hiredate,'yyyy'),'1981',1,0)) "1981",
  4         sum(decode(to_char(hiredate,'yyyy'),'1982',1,0)) "1982",
  5         sum(decode(to_char(hiredate,'yyyy'),'1987',1,0)) "1987"
  6  from emp;
```

SQL 的类型
1. DML（data manipulation Language 数据操作语言）: insert  update delete select
2. DDL(Data Definition Language 数据定义语言): create table,alter table,drop table,truncate table
                                               create/drop view,sequence(序列),index,synonym(同义词)
3. DCL(Data Control Language 数据控制语言): grant(授权) revoke（撤销权限）


插入 insert
```sql
insert into emp(empno,ename,sal,deptno) values(1001,'Tom',3000,10);
```


地址符 & (PreparedStatement pst = "insert into emp(empno,ename,sal,deptno) values(?,?,?,?)")
```sql
insert into emp(empno,ename,sal,deptno) values(&empno,&ename,&sal,&deptno);
输入 empno 的值:  1002
输入 ename 的值:  'Mary'
输入 sal 的值:  2000
输入 deptno 的值:  30
原值    1: insert into emp(empno,ename,sal,deptno) values(&empno,&ename,&sal,&deptno)
新值    1: insert into emp(empno,ename,sal,deptno) values(1002,'Mary',2000,30)
```






一次性将emp中，所有10号部门的员工插入到emp10中
```sql
insert into emp10 select * from emp where deptno=10;
```


海量拷贝数据
```
1. 数据泵(datapump) ---> plsql
2. SQL*Loader
3. (数据仓库)外部表
4. 可传输的表空间
```
delete和truncate的区别:
```sql
1. delete逐条删除；truncate先摧毁表，再重建
2.(根本)delete是DML，truncate是DDL
    （可以回滚）          （不可以回滚）
3. delete不会释放空间 truncate会
4. delete可以闪回  truncate不可以
   (flashback)
5. delete会产生碎片；truncate不会
```

执行时间
```sql
set feedback off
set timing on
 delete from testdelete;
 已用时间:  00: 00: 00.06

drop table testdelete purge;
@d:\temp\testdelete.sql
truncate table testdelete;
已用时间:  00: 00: 00.15
undo数据（还原数据）
```




事务的标致
```
1. 起始标志：事务中第一条DML语句
2. 结束标志：提交： 显式 commit
                    隐式 正常退出（exit），DDL，DCL
             回滚:   显式 rollback
                     隐式 非正常退出，掉电，宕机
```

savepoint
```sql
create table testsavepoint
  2  (tid number, tname varchar2(20));

   savepoint a;
   insert into testsavepoint values(3,'Maake');
   rollback to savepoint a;
   select * from testsavepoint;
```
事务处理集。
```sql
set transaction read only;
```

```sql
create table test3
 2  (tid number,
 3   tname varchar2(20),
 4   hiredate date default sysdate);

insert into test3(tid,tname) values(1,'Tom');
select * from test3;
```


行地址 rowid
```sql
select rowid,empno,ename,sal from emp;
select empno,ename,sal from emp where rowid='AAAMfPAAEAAAAAgAAK';
```







创建表，保存20号部门的员工
```sql
create table emp20
 2  as
 3  select * from emp where deptno=20;
 select * from emp20;
```




创建表，员工号 姓名  月薪 年薪 部门名称

```sql
 1  create table empinfo
 2  as
 3  select e.empno,e.ename,e.sal,e.sal*12 annsal,d.dname
 4  from emp e, dept d
 5* where e.deptno=d.deptno
 select * from empinfo;
```

修改表：追加新列，修改列，删除列，重命名列，重命名表


```sql
alter table test3 add photo blob;
alter table test3 modify tname varchar2(40)
alter table test3 drop column photo;
alter table test3 rename column tname to username;
rename test3 to test5;
drop table test5;
```




Oracle的回收站 (注意：管理员没有回收站)
```sql
show recyclebin
purge recyclebin; //回收站已清空
```



查询所有表
```sql
select * from tab;
```





回收站查询
```sql
select * from "BIN$+0nemp5PSe2adQphqd6t4A==$0";
```




闪回删除
```sql
flashback table TESTSAVEPOINT to before drop;
show recyclebin
select * from TESTSAVEPOINT;
```
check
```sql
create table test5
 2  (tid number,
 3   tname varchar2(20),
 4   gender varchar2(2) check (gender in ('男','女')),
 5   sal number check (sal > 0)
 6  );

 insert into test5 values(1,'Tom','男',1000);
 insert into test5 values(2,'Mike','啊',1000);
 insert into test5 values(2,'Mike','啊',1000)
 违反检查约束条件 (SCOTT.SYS_C005393)
```
约束 constraint
```sql
create table student
 2  (
 3    sid number constraint student_pk primary key,
 4    sname varchar2(20) constraint student_name_notnull not null,
 5    gender varchar2(2) constraint student_gender check (gender in ('男','女')),
 6    email varchar2(40) constraint student_email_unique unique
 7                       constraint student_email_notnull not null,
 8    deptno number constraint student_fk references dept(deptno) on delete set null
 9  );
 insert into student values(1,'Tom','男','tom@126.com',10)
 insert into student values(1,'Tom','男','tom@126.com',10)

 违反唯一约束条件 (SCOTT.STUDENT_EMAIL_UNIQUE)
```

视图 (物化视图可以缓存数据提高效率)
```sql
create view empinfoview
 2  as
 3  select e.empno,e.ename,e.sal,e.sal*12 annsal,d.dname
 4  from emp e, dept d
 5  where e.deptno=d.deptno;

 select * from empinfoview;
 需要管理员授权:grant create view to scott
```
创建或替换视图 create or replace view
```sql
create or replace view empinfoview
 2  as
 3  select e.empno,e.ename,e.sal,e.sal*12 annsal,d.dname
 4  from emp e, dept d
 5  where e.deptno=d.deptno
 6  with read only;
```



序列
```sql
create sequence myseq;
create table testseq (tid number,tname varchar2(20));

select myseq.currval from dual;
序列 MYSEQ.CURRVAL 尚未在此会话中定义
select myseq.nextval from dual;
select myseq.currval from dual;
insert into testseq values(myseq.nextval,'aaa');
commit;
rollback;//会产生裂缝
select * from testseq;

```

同义词 （别名）提高安全性 为emp表起别名

```sql
create synonym myemp for emp;
ORA-01031: 权限不足
需要管理员授权: grant create [public]synonym to scott
create synonym myemp1 for hr.employees;
需要管理员授权: grant select on hr.employees to scott
select count(*) from hr.employees;
select count(*) from myemp1;
```
