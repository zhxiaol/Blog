---
layout: post
title: BOS登陆
tags:
- java

categories: java
description: BOS登陆
---
##### 数据库设计
###### 创建t_user表
```
create table t_user(id varchar(32) not null,username varchar(20) not null,
password varchar(32) not null,salary double,birthday date,gender varchar(10),
station varchar(40), telephone varchar(11),remark varchar(255),primary key(id));
```
###### 生成POJO类
```
1.添加DataSource设置
2.将Hibernate配置文件添加到Facets中
3.将Spring配置文件添加到Facets中
4.打开Persistence窗口自动生成User类和Mapping
```
##### 持久层设计

###### IBaseDao接口
```
public interface IBaseDao<T> {
     void save(T entity);
     void delete(T entity);
     void update(T entity);
     T findById(Serializable id);
     List<T>findAll();
}
```
###### BaseDaoImpl实现类
```
public class BaseDaoImpl<T> extends HibernateDaoSupport implements IBaseDao<T> {
    Class<T> entityClass;
    //在构造方法中动态获得操作的实体类型
    public BaseDaoImpl() {
        ParameterizedType genericSuperclass = (ParameterizedType) this.getClass().getGenericSuperclass();
        entityClass= (Class<T>) genericSuperclass.getActualTypeArguments()[0];

    }
    //@Autowired Spring提供的方式
    //@Qualifier("sessionFactory") spring指定bean名称
    @Resource   //(name = "sessionFactory")不指定名称按类型注入 JDK1.7提供
    public void setMySessionFactory(SessionFactory sessionFactory){
        super.setSessionFactory(sessionFactory);
    }
    @Override
    public void save(T entity) {
        this.getHibernateTemplate().save(entity);
    }

    @Override
    public void delete(T entity) {
        this.getHibernateTemplate().delete(entity);
    }

    @Override
    public void update(T entity) {
        this.getHibernateTemplate().update(entity);
    }

    @Override
    public T findById(Serializable id) {
        this.getHibernateTemplate().get(entityClass,id);
        return null;
    }

    @Override
    public List<T> findAll() {
        String hql="FROM "+entityClass.getSimpleName();
        return this.getHibernateTemplate().find(hql);
    }
}
```
###### UserDaoImpl
```
public interface IUserDao<User> extends IBaseDao<User> {
}

@Repository
//@Scope("prototype")
public class UserDaoImpl extends BaseDaoImpl<User> implements IUserDao<User> {
}
```
##### 表现层设计
###### BaseAction
```
public class BaseAction<T> extends ActionSupport implements ModelDriven<T> {
    private  T model;
    //在构造方法中获得实体类型创建对象
    public BaseAction() {
        try {
            ParameterizedType type= (ParameterizedType) this.getClass().getGenericSuperclass();
            Class<T> clazz = (Class<T>) type.getActualTypeArguments()[0];
            model=clazz.newInstance();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    @Override
    public T getModel() {
        return model;
    }
}
```

##### 用户登陆
###### UserService
```
public interface IUserService {
    User login(User model);
}

@Service
@Transactional
public class UserServiceImpl implements IUserService {
    @Autowired
    private IUserDao userDao;

    @Override
    public User login(User user) {
        String username=user.getUsername();
        String password=user.getPassword();
        password=MD5Utils.md5(password);
        return userDao.findUserByUsernameAndPassword(username,password);
    }

    public UserServiceImpl setUserDao(IUserDao userDao) {
        this.userDao = userDao;
        return this;
    }
}
```


###### UserAction
```
@Controller  //默认bean id是类名首字符小写
@Scope("prototype")
public class UserAction extends BaseAction<User> {
    //通过属性驱动接受验证码
    private String checkcode;
    @Resource
    private IUserService userService;
    public String login(){
        //判断验证码
        String key = (String) ServletActionContext.getRequest().getSession().getAttribute("key");
        if(StringUtils.isNotBlank(checkcode)&&checkcode.equals(key)){
            //验证码正确
            User user=userService.login(model);
            if(user != null){
                //登陆成功,将User放入session域,跳转到系统首页
                ServletActionContext.getRequest().getSession().setAttribute("loginUser",user);
                return "home";
            }else{
                //登陆失败,设置错误提示,跳转到登录页面
                this.addActionError(this.getText("loginError"));
                return "login";
            }
        }else {//验证码错误
            this.addActionError(this.getText("validateCodeError"));
            return "login";
        }
    }

    public UserAction setUserService(IUserService userService) {
        this.userService = userService;
        return this;
    }

    public void setCheckcode(String checkcode) {
        this.checkcode = checkcode;
    }
}
```

###### UserDao
```
@Repository
//@Scope("prototype")
public class UserDaoImpl extends BaseDaoImpl<User> implements IUserDao {
    @Override
    public User findUserByUsernameAndPassword(String username, String password) {
        String hql="FROM User u where u.username = ? and u.password = ?";
        List<User> list = this.getHibernateTemplate().find(hql, username, password);
        if(list!=null&&list.size()>0)
        return list.get(0);
        return null;
    }
}
```

##### EasyUI Messager
```
<script type="text/javascript" src="${pageContext.request.contextPath}/js/easyui/locale/easyui-lang-zh_CN.js"></script>
<script type="text/javascript" src="${pageContext.request.contextPath }/js/easyui/jquery.easyui.min.js"></script>
<script type="text/javascript">
    $(function () {

        $.messager.alert("标题", "内容信息", "info");

        window.setTimeout(function () {
            $.messager.show({
                title: '欢迎信息',
                msg: '欢迎张三登陆系统',
                timeout: 3000,
                showType: 'slide'
            })
        }, 3000)

        $.messager.confirm("标题", "内容:你确定删除当前数据吗", function (r) {
            alert(r)
        });

        $.messager.prompt("标题", "内容", function (data) {
            alert(data)
        })

        $.messager.progress();
        window.setTimeout(function () {
            $.messager.progress('close')
        }, 3000)

    })
</script>
```

##### EasyUI下拉菜单MeunButton
```
<%@ page language="java" contentType="text/html; charset=UTF-8"
         pageEncoding="UTF-8" %>
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>下拉菜单</title>
    <link rel="stylesheet" type="text/css"href="${pageContext.request.contextPath }/js/easyui/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="${pageContext.request.contextPath }/js/easyui/themes/icon.css">
    <script type="text/javascript" src="${pageContext.request.contextPath }/js/jquery-1.8.3.js"></script>
    <script type="text/javascript" src="${pageContext.request.contextPath}/js/easyui/locale/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="${pageContext.request.contextPath }/js/easyui/jquery.easyui.min.js"></script>
</head>
<body>
<a data-options="iconCls:'icon-help',menu:'#mm'" class="easyui-menubutton">控制面板</a>
<%--使用div制作下拉菜单选项--%>
<div id="mm">
    <%--使用子div制作具体的选项--%>
    <div data-options="iconCls:'icon-edit'" onclick="alert('修改密码')">修改密码</div>
    <div>联系管理员</div>
    <div class="menu-sep"></div>
    <div>退出系统</div>
</div>
</body>
</html>
```
###### 退出登录
```
//退出登录
public String logout(){
    ServletActionContext.getRequest().getSession().invalidate();
    return "login";
}
```

###### 自定义拦截器
```
//定义一个拦截器
public class BOSLoginInterceptor extends MethodFilterInterceptor {
    @Override
    protected String doIntercept(ActionInvocation actionInvocation) throws Exception {
        User user = (User) ServletActionContext.getRequest().getSession().getAttribute("loginUser");
        if(user == null){
            return "login";
        }
        return actionInvocation.invoke();
    }
}


//在struts.xml中注册拦截器
<package name="basicstruts2" extends="struts-default">
    <interceptors>
        <interceptor name="BOSLoginInterceptor" class="com.itheima.bos.web.interceptor.BOSLoginInterceptor">
            <param name="excludeMethods">login</param>
        </interceptor>
        <interceptor-stack name="myStack">
            <interceptor-ref name="BOSLoginInterceptor"/>
            <interceptor-ref name="defaultStack"/>
        </interceptor-stack>
    </interceptors>
    <default-interceptor-ref name="myStack"/>
    <global-results>
        <result name="login">/login.jsp</result>
    </global-results>
</package>
```

##### 基于Ajax修改密码
```
<!--修改密码窗口-->
<div id="editPwdWindow" class="easyui-window" title="修改密码" collapsible="false" minimizable="false" modal="true"
     closed="true" resizable="false"
     maximizable="false" icon="icon-save" style="width: 300px; height: 160px; padding: 5px;
        background: #fafafa">
    <div class="easyui-layout" fit="true">
        <div region="center" border="false" style="padding: 10px; background: #fff; border: 1px solid #ccc;">
            <form id="editPasswordForm">
                <table cellpadding=3>
                    <tr>
                        <td>新密码：</td>
                        <td><input id="txtNewPass" type="Password" class="txt01 easyui-validatebox"
                                   required="true" data-options="validType:'length[4,8]'"/></td>
                    </tr>
                    <tr>
                        <td>确认密码：</td>
                        <td><input id="txtRePass" type="Password" class="txt01 easyui-validatebox"
                                   required="true" data-options="validType:'length[4,8]'"/></td>
                    </tr>
                </table>
            </form>
        </div>
        <div region="south" border="false" style="text-align: right; height: 30px; line-height: 30px;">
            <a id="btnEp" class="easyui-linkbutton" icon="icon-ok" href="javascript:void(0)">确定</a>
            <a id="btnCancel" class="easyui-linkbutton" icon="icon-cancel" href="javascript:void(0)">取消</a>
        </div>
    </div>
</div>


//取消按钮
$("#btnCancel").click(function () {
        $('#editPwdWindow').window('close');
    });
    //为确定按钮绑定事件
    $("#btnEp").click(function () {
        var v=$("#editPasswordForm").form("validate")
        if(v){//校验通过了
            //判断2次密码是否一致
            var p1=$("#txtNewPass").val()
            var p2=$("#txtRePass").val()
            if(p1 == p2){
                var url="${pageContext.request.contextPath}/userAction_editPassword.action";
                $.post(url,{"password":p1},function (data) {
                    $('#editPwdWindow').window('close');
                    if(data == "1"){//修改成功
                            $.messager.alert("提示信息","密码修改成功","info")
                    }else{
                            $.messager.alert("提示信息","密码修改失败,请稍后重试","error")
                    }
                })
            }else {
                $.messager.alert("提示消息","两次输入密码不一致","warning")
            }
        }

    });
});

//UserAction.java
//修改密码
public String editPassword() throws IOException {
    User loginUser = (User) ServletActionContext.getRequest().getSession().getAttribute("loginUser");
    String password = MD5Utils.md5(model.getPassword());
    String flag="1";
    try {
        userService.editPassword(password,loginUser.getId());
    } catch (Exception e) {
        e.printStackTrace();
        flag="0";
    }
    HttpServletResponse resp = ServletActionContext.getResponse();
    resp.setContentType("text/html;charset=utf-8");
    resp.getWriter().print(flag);
    return NONE;
}


//User.hbm.xml
//在class标签外面
<query name="editPassword">
    update User set password = ? where id =?
</query>

//UserServiceImpl
@Override
public void editPassword(String password, String id) {
    userDao.executeUpdate("editPassword",password,id);
}

//UserDaoImpl
@Override
public void executeUpdate(String queryName, Object... objects) {
    Session session = (Session) getSession();
    Query query = session.getNamedQuery(queryName);
    int i=0;
    for (Object object : objects) {
        query.setParameter(i++,object);
    }
    query.executeUpdate();
}
```

##### 解决EasyUI window控件bug
> 引入outOfBounds.js
